# 📊 PomeloX React Native 新架构迁移总体计划

## 🎯 项目概述

**项目名称**: PomeloX Mobile App
**当前版本**: 1.0.31
**React Native**: 0.76.9
**Expo SDK**: 52.0.0
**生产状态**: 已上线App Store
**用户规模**: 500+ 活跃用户

## 🔍 当前架构基线

### 技术栈现状
- **架构模式**: Legacy Bridge (传统桥接)
- **JS引擎**: JSC (JavaScriptCore)
- **渲染器**: Paper Renderer
- **原生模块**: Legacy Native Modules
- **新架构状态**: 完全未启用

### 关键配置
```json
// app.json
"newArchEnabled": false
"jsEngine": "jsc"

// iOS
"newArchEnabled": "false"
"expo.jsEngine": "jsc"

// Android
newArchEnabled=false
hermesEnabled=false
```

---

## 🎯 阶段化迁移矩阵（调整版）

### **阶段 0: 基线检测与风险评估** ✅

**目标**: 建立迁移基础和风险评估（不改运行时）

**必须完成**:
- ✅ 版本兼容性确认 (RN 0.76.9 + Expo 52)
- ⚠️ 第三方库兼容性审计 (12个关键库)
- ✅ 性能基准测试建立
- ✅ 迁移分支创建
- ✅ 一键回滚开关准备

**成功标准**:
- 所有依赖库兼容性报告
- 当前性能基准数据
- 回滚机制就绪

---

### **阶段 1: 预处理准备** 🟢

**目标**: 优化构建配置和依赖准备（不改运行时）

**工作内容**:
- **Babel 插件顺序**: 确保 Reanimated 插件在最后
- **Intl 冲突处理**: 解决 polyfills 冲突
- **ProGuard 配置**: 添加必要的 keep 规则
- **构建脚本**: 优化构建流程
- **EAS 渠道化**: 配置 internal/preview/production

**验证清单**:
- [ ] Babel 配置正确
- [ ] 构建脚本测试通过
- [ ] EAS 渠道配置完成
- [ ] 符号化流程验证

---

### **阶段 2: 新架构启用（JSC + Fabric + TurboModules）** 🔴

**目标**: 启用新架构，但暂不切换 JS 引擎

**策略说明**:
- 将"架构升级"和"引擎切换"解耦，降低风险
- 先验证新架构稳定性，再考虑 Hermes
- 基于之前 Hermes 闪退经验，将引擎风险独立处理

**配置变更**:
```json
// iOS 先行
"newArchEnabled": true
"jsEngine": "jsc"  // 暂不切换 Hermes

// Android 可选择延后（阶段5对齐）
```

**关键依赖兼容性**:

| 库名 | 版本 | 新架构支持 | 操作方案 |
|---|---|---|---|
| react-native-reanimated | 3.16.1 | ✅ 完全支持 | 保持不变 |
| react-native-screens | 4.4.0 | ✅ 完全支持 | 保持不变 |
| react-native-gesture-handler | 2.20.2 | ✅ 完全支持 | 保持不变 |
| react-native-safe-area-context | 4.12.0 | ✅ 完全支持 | 保持不变 |
| react-native-svg | 15.8.0 | ✅ 完全支持 | 保持不变 |
| **@react-native-community/blur** | 4.4.1 | ❌ 不支持 | **删除，已有expo-blur** |
| **react-native-fast-image** | 8.6.3 | ⚠️ 需要patch | **先测试，后决定** |

**依赖处理策略**:
- **@react-native-community/blur**: 直接删除（项目已使用 expo-blur）
- **react-native-fast-image**:
  - 先评估使用场景数量
  - 少量场景 → 替换为 expo-image
  - 大量场景 → 先跑稳新架构，后续再决定
- **react-native-qrcode-svg/base64**: 验证后决定，准备纯JS备选

---

### **阶段 3: 热点性能优化** 🟡

**目标**: 优化关键性能瓶颈

**优化项目**:

1. **列表组件升级** (优先级: 高):
   ```typescript
   // 12个文件的 FlatList → FlashList
   import { FlashList } from '@shopify/flash-list';
   ```
   - 长列表页面平均 FPS 提升
   - 掉帧率降低
   - 允许个别极端页面临时回滚

2. **动画优化** (优先级: 中):
   - 必要动画改用 Reanimated 3
   - 确保 useNativeDriver: true
   - 移除不必要的动画

3. **存储优化** (可选):
   - 考虑 MMKV 替代 AsyncStorage
   - 提升读写性能

**成功标准**:
- 列表滚动 FPS ≥ 55
- 无明显掉帧
- 用户体验改善可感知

---

### **阶段 4: Hermes 引擎灰度** 🔴

**目标**: 在新架构稳定后，灰度测试 Hermes

**重要前提**:
- 新架构已稳定运行 2-4 周
- 所有功能测试通过
- 性能基线已建立

**灰度策略**:
```
5% (1周) → 15% (1周) → 30% (2周) → 50% → 100%
```

**配置变更**:
```json
"jsEngine": "hermes"
hermesEnabled=true
```

**关键注意事项**:
- **禁用 OTA/热更新**（跨引擎必须完整重签包）
- **一键回滚开关**: `"jsEngine": "jsc"` 立即回滚
- **崩溃率阈值**:
  - 警戒线: 基线 +5%
  - 回滚线: 基线 +10%
  - 秒退: 立即全量回滚

**成功标准（调整后）**:
- **硬门槛**: 启动/内存/TTI 不劣化
- **目标值**: ≥5-10% 性能提升
- **加分项**: >10% 提升

---

### **阶段 5: Android 平台对齐** 🟡

**目标**: Android 追平 iOS 进度

**执行策略**:
1. 先启用新架构（JSC）
2. 验证稳定性
3. 根据 iOS Hermes 经验决定是否启用

**平台差异处理**:
- 处理 Android 特有的兼容性问题
- 优化 Android 特定性能瓶颈
- 确保双平台体验一致

---

### **阶段 6 (可选): 版本升级** 🟢

**目标**: 升级到最新稳定版

**升级内容**:
- React Native 0.78/0.79
- React 19
- 对应依赖矩阵更新

**前提条件**:
- 当前架构已稳定 3 个月
- 明确的功能需求驱动
- 充分的升级收益评估

**预期整体收益**:
| 指标 | 当前 | 新架构+JSC | 新架构+Hermes |
|---|---|---|---|
| 启动时间 | 3.2s | 2.8s (-13%) | 2.3s (-28%) |
| 列表FPS | 55fps | 58fps | 59fps |
| 内存占用 | 180MB | 165MB | 150MB |
| JS Bundle | 3MB | 3MB | 2.5MB |

---

## 🚨 关键风险点与缓解策略

### **高风险依赖处理**

#### 1. react-native-fast-image
**问题**: 新架构支持不完整
**解决方案**:
- 方案A: 升级到最新版本
- 方案B: 迁移到 expo-image
- 方案C: 维护自定义patch

#### 2. @react-native-community/blur
**问题**: 完全不支持新架构
**解决方案**:
- 必须替换为 expo-blur
- 需要更新所有使用该组件的文件

### **中风险依赖处理**

#### 1. react-native-qrcode-svg
**策略**: 在测试环境充分验证

#### 2. react-native-base64
**策略**: 评估纯JS替代方案

---

## 📋 推荐迁移路径（更新版）

### **保守方案** (推荐生产环境) ✅
```
阶段0-1 (基线+预处理) → 阶段2 (新架构+JSC) → 稳定2周 →
阶段3 (性能优化) → 阶段4 (Hermes灰度) → 阶段5 (Android对齐)
```

**时间线**: 3-4个月
**风险**: 低（分步验证）
**收益**: 稳定可控

### **激进方案** (不推荐)
```
阶段2+3 同时 → 快速迭代 → 集中解决问题
```

**风险**: 高（问题难定位）

### **推荐执行策略**:
1. **iOS 先行**: 利用已有 iOS 优先策略
2. **架构引擎解耦**: 新架构先稳定，Hermes 后灰度
3. **灰度纪律**: 严格的崩溃率监控和回滚机制
4. **Android 延后**: 基于 iOS 经验再推进

---

## ⚡ 成功标准（调整版）

### **每阶段通用标准**:
- **硬门槛**: 不退步（性能不劣化、功能不缺失）
- **目标值**: 可量化提升（具体指标因阶段而异）
- **加分项**: 超预期改善

### **阶段2 (新架构) 成功标准**:
- [ ] **硬门槛**: 启动/TTI/内存不劣化
- [ ] **目标值**: UI响应提升 5-10%
- [ ] **验证项**: 所有功能正常，无新增崩溃

### **阶段3 (性能优化) 成功标准**:
- [ ] **硬门槛**: 长列表页面 FPS ≥ 55
- [ ] **目标值**: 掉帧率降低 30%
- [ ] **灵活性**: 允许个别极端页面临时回滚

### **阶段4 (Hermes) 成功标准**:
- [ ] **硬门槛**: 崩溃率 ≤ 基线 +5%
- [ ] **目标值**: 启动/内存改善 5-10%
- [ ] **回滚线**: 崩溃率 > 基线 +10% 或秒退

### **整体项目成功标准**:
- [ ] iOS 稳定运行 1 个月
- [ ] 用户体验可感知改善
- [ ] 具备快速回滚能力
- [ ] 为 RN 0.78+ 升级做好准备

---

## 📞 联系与支持

**项目负责人**: 开发团队
**技术审查**: 架构团队
**风险评估**: QA团队
**上线决策**: 产品团队

**文档更新**: 2025年09月23日
**下次审查**: 根据阶段进展决定

---

*此文档将随着迁移进展持续更新，确保团队对迁移状态和风险有清晰认知。*