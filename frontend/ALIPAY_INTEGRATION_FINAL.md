# âœ… æ”¯ä»˜å®iOS SDKé›†æˆ - æœ€ç»ˆå®ŒæˆæŠ¥å‘Š

**å®Œæˆæ—¶é—´**: 2025-01-21
**çŠ¶æ€**: ğŸ‰ **å…¨éƒ¨å®Œæˆ**

---

## ğŸ“‹ æŠ€æœ¯æ¸…å•ï¼ˆå…¨éƒ¨å®Œæˆï¼‰

### âœ… 1. iOSåŸç”ŸSDKé›†æˆ

| é¡¹ç›® | çŠ¶æ€ | è¯¦æƒ… |
|------|------|------|
| AlipaySDK-iOS | âœ… | v15.8.30ï¼Œé€šè¿‡CocoaPodså®‰è£… |
| Podfileé…ç½® | âœ… | æ·»åŠ  `pod 'AlipaySDK-iOS'` |
| pod install | âœ… | 106ä¸ªpodså®‰è£…æˆåŠŸ |

### âœ… 2. åŸç”Ÿæ¡¥æ¥æ¨¡å—

| æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| RNAlipayModule.h | âœ… | æ¨¡å—å¤´æ–‡ä»¶ï¼Œå£°æ˜æ¥å£ |
| RNAlipayModule.m | âœ… | æ¨¡å—å®ç°ï¼Œè°ƒç”¨AlipaySDK |
| Xcodeé¡¹ç›®å¼•ç”¨ | âœ… | å·²è‡ªåŠ¨æ·»åŠ åˆ°project.pbxprojï¼ˆ6å¤„å¼•ç”¨ï¼‰ |
| Build Phases | âœ… | RNAlipayModule.må·²æ·»åŠ åˆ°Compile Sources |

### âœ… 3. iOSåº”ç”¨é…ç½®

| é…ç½®é¡¹ | çŠ¶æ€ | å€¼ |
|--------|------|-----|
| URL Scheme | âœ… | `pomelox://` |
| LSApplicationQueriesSchemes | âœ… | `alipay`, `alipays`, `alipayshare` |
| AppDelegateå›è°ƒ | âœ… | å·²é›†æˆæ”¯ä»˜å®å›è°ƒå¤„ç† |

### âœ… 4. React Nativeå‰ç«¯

| ç»„ä»¶ | çŠ¶æ€ | åŠŸèƒ½ |
|------|------|------|
| alipayService.ts | âœ… | SDKé›†æˆæ–¹å¼ï¼Œè°ƒç”¨åŸç”Ÿæ¨¡å— |
| payWithAlipay() | âœ… | å”¤èµ·æ”¯ä»˜å®SDK |
| createAndPayAlipayOrder() | âœ… | ä¸€é”®åˆ›å»ºè®¢å•å¹¶æ”¯ä»˜ |
| addPaymentResultListener() | âœ… | äº‹ä»¶ç›‘å¬ï¼ˆå¤‡ç”¨ï¼‰ |
| getAlipaySDKVersion() | âœ… | è°ƒè¯•å·¥å…· |
| Orderç±»å‹ | âœ… | åŒ…å«orderStringå­—æ®µ |

### âœ… 5. æ–‡æ¡£

| æ–‡æ¡£ | çŠ¶æ€ | å†…å®¹ |
|------|------|------|
| ALIPAY_SDK_INTEGRATION.md | âœ… | å®Œæ•´æŠ€æœ¯æ–‡æ¡£ï¼ˆ500+è¡Œï¼‰ |
| ALIPAY_SDK_SETUP.md | âœ… | å¿«é€Ÿæ“ä½œæŒ‡å— |
| XCODE_SETUP_GUIDE.md | âœ… | Xcodeæ“ä½œè¯¦ç»†æ­¥éª¤ |
| AlipayPaymentExample.tsx | âœ… | ä»£ç ä½¿ç”¨ç¤ºä¾‹ |
| ALIPAY_SETUP_COMPLETE.md | âœ… | å®ŒæˆæŠ¥å‘Šï¼ˆç¬¬ä¸€ç‰ˆï¼‰ |

---

## ğŸ¯ æŒ‰ç…§ä½ çš„æˆªå›¾ - å®Œæ•´å¯¹ç…§

æ ¹æ®ä½ åˆ†äº«çš„æ”¯ä»˜å®iOSé›†æˆæµç¨‹å›¾ï¼Œæˆ‘ä»¬å·²å®Œæˆæ‰€æœ‰æŠ€æœ¯æ­¥éª¤ï¼š

### å®¢æˆ·ç«¯ä¾§ï¼ˆå‰ç«¯ - å…¨éƒ¨å®Œæˆ âœ…ï¼‰

1. âœ… **æ‰“å¼€ç”¨æˆ·APPä¸‹å•** â†’ ç”¨æˆ·ç•Œé¢å·²å‡†å¤‡
2. âœ… **è°ƒç”¨å•†æˆ·æœåŠ¡ç«¯æ¥å£** â†’ `orderAPI.createOrder()`
3. âœ… **è·å–orderStr** â†’ åç«¯è¿”å›orderStringå­—æ®µ
4. âœ… **è°ƒç”¨SDKæ‰“å¼€æ¥å£** â†’ `RNAlipay.pay(orderStr, scheme)`
5. âœ… **å”¤èµ·æ”¯ä»˜å®** â†’ AlipaySDKå¤„ç†
6. âœ… **æ¥æ”¶æ”¯ä»˜ç»“æœ** â†’ URLå›è°ƒ + Promiseè¿”å›
7. âœ… **å±•ç¤ºç»“æœ** â†’ `isPaymentSuccess()` åˆ¤æ–­

### iOSåŸç”Ÿä¾§ï¼ˆNative - å…¨éƒ¨å®Œæˆ âœ…ï¼‰

1. âœ… **AlipaySDKé›†æˆ** â†’ podå®‰è£…æˆåŠŸ
2. âœ… **åŸç”Ÿæ¨¡å—** â†’ RNAlipayModule.h/måˆ›å»º
3. âœ… **URL Schemeé…ç½®** â†’ Info.plisté…ç½®å®Œæˆ
4. âœ… **å›è°ƒå¤„ç†** â†’ AppDelegateé›†æˆå®Œæˆ
5. âœ… **Xcodeé¡¹ç›®é…ç½®** â†’ æ–‡ä»¶å·²æ·»åŠ åˆ°é¡¹ç›®
6. âœ… **ç¼–è¯‘é…ç½®** â†’ Build Phaseså·²è®¾ç½®

### æœåŠ¡ç«¯ä¾§ï¼ˆåç«¯ - éœ€è¦ç¡®è®¤ âš ï¸ï¼‰

1. âš ï¸ **åˆ›å»ºæ”¯ä»˜å®è®¢å•** â†’ éœ€è¦åç«¯å®ç°
2. âš ï¸ **è¿”å›orderString** â†’ éœ€è¦åç«¯è¿”å›æ­¤å­—æ®µ
3. âš ï¸ **æ¥æ”¶å¼‚æ­¥é€šçŸ¥** â†’ éœ€è¦åç«¯å®ç°notify_url
4. âš ï¸ **éªŒè¯ç­¾å** â†’ éœ€è¦åç«¯éªŒè¯æ”¯ä»˜å®ç­¾å
5. âš ï¸ **æ›´æ–°è®¢å•çŠ¶æ€** â†’ éœ€è¦åç«¯é€»è¾‘

---

## ğŸš€ ç°åœ¨å¯ä»¥åšä»€ä¹ˆ

### ç«‹å³æµ‹è¯•ï¼ˆæ¨èï¼‰

```bash
cd /Users/jietaoxie/pomeloX/frontend
npm run ios
```

### å¿«é€Ÿæµ‹è¯•ä»£ç 

åœ¨ä»»æ„Screenä¸­æ·»åŠ æµ‹è¯•æŒ‰é’®ï¼š

```typescript
import { useState } from 'react';
import { createAndPayAlipayOrder, isPaymentSuccess } from '../services/alipayService';
import { OrderType } from '../types/order';

const [loading, setLoading] = useState(false);

const testAlipay = async () => {
  try {
    setLoading(true);

    const { order, paymentResult } = await createAndPayAlipayOrder({
      itemId: 123,
      itemName: 'æµ‹è¯•æ”¯ä»˜',
      price: 0.01, // 1åˆ†é’±æµ‹è¯•
      orderType: OrderType.PAID_ACTIVITY,
    });

    if (isPaymentSuccess(paymentResult.resultStatus)) {
      Alert.alert('âœ… æ”¯ä»˜æˆåŠŸ', `è®¢å•å·: ${order.orderNo}`);
    } else {
      Alert.alert('âŒ æ”¯ä»˜å¤±è´¥', paymentResult.memo);
    }
  } catch (error: any) {
    Alert.alert('é”™è¯¯', error.message);
    console.error('æ”¯ä»˜é”™è¯¯:', error);
  } finally {
    setLoading(false);
  }
};
```

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥åŸç”Ÿæ¨¡å—æ˜¯å¦åŠ è½½

è¿è¡Œåº”ç”¨åï¼Œåœ¨æ§åˆ¶å°æ‰§è¡Œï¼š

```typescript
import { NativeModules } from 'react-native';
console.log('RNAlipay:', NativeModules.RNAlipay);
```

åº”è¯¥è¾“å‡ºæ¨¡å—å¯¹è±¡ï¼Œè€Œä¸æ˜¯undefinedã€‚

### 2. æµ‹è¯•SDKç‰ˆæœ¬

```typescript
import { getAlipaySDKVersion } from '../services/alipayService';

const version = await getAlipaySDKVersion();
console.log('æ”¯ä»˜å®SDKç‰ˆæœ¬:', version);
// åº”è¯¥è¾“å‡º: "15.8.30"
```

### 3. æµ‹è¯•å®Œæ•´æ”¯ä»˜æµç¨‹

1. ç‚¹å‡»æ”¯ä»˜æŒ‰é’®
2. è§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼š
   ```
   ğŸ’³ [Alipay SDK] åˆ›å»ºæ”¯ä»˜å®è®¢å•...
   ğŸ“± [Alipay iOS SDK] è°ƒç”¨åŸç”Ÿæ”¯ä»˜æ¨¡å—...
   ğŸ’³ [RNAlipay] å¼€å§‹æ”¯ä»˜å®æ”¯ä»˜...
   ```
3. è·³è½¬åˆ°æ”¯ä»˜å®app
4. å®Œæˆæ”¯ä»˜ï¼ˆæ²™ç®±è´¦å·ï¼‰
5. è¿”å›åº”ç”¨
6. æŸ¥çœ‹æ”¯ä»˜ç»“æœ

---

## ğŸ“Š æŠ€æœ¯æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          React Native (JavaScript)          â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    alipayService.ts                 â”‚  â”‚
â”‚  â”‚    - createAndPayAlipayOrder()      â”‚  â”‚
â”‚  â”‚    - payWithAlipay()                â”‚  â”‚
â”‚  â”‚    - isPaymentSuccess()             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                    â†“                        â”‚
â”‚           NativeModules.RNAlipay            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Native Bridge (RNAlipayModule)        â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   RNAlipayModule.m                  â”‚  â”‚
â”‚  â”‚   - pay(orderString, scheme)        â”‚  â”‚
â”‚  â”‚   - getVersion()                    â”‚  â”‚
â”‚  â”‚   - handleOpenURL(url)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           AlipaySDK (iOS Native)            â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   AlipaySDK.framework               â”‚  â”‚
â”‚  â”‚   - payOrder:fromScheme:callback:   â”‚  â”‚
â”‚  â”‚   - processOrderWithPaymentResult:  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ”¯ä»˜å®å®¢æˆ·ç«¯ / H5                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ åç«¯è¦æ±‚ï¼ˆéœ€è¦ç¡®è®¤ï¼‰

### å¿…é¡»è¿”å›çš„å­—æ®µ

åç«¯ `/app/order/createOrder` æ¥å£**å¿…é¡»**è¿”å›ï¼š

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "id": 456,
    "orderNo": "ORD20250101123456",
    "orderString": "alipay_sdk=...",  // â­ å…³é”®å­—æ®µ
    "..."
  }
}
```

### å¼‚æ­¥é€šçŸ¥å¤„ç†

åç«¯éœ€è¦å®ç°æ”¯ä»˜å®å¼‚æ­¥é€šçŸ¥æ¥å£ï¼š

```python
# ä¼ªä»£ç ç¤ºä¾‹
@app.post("/alipay/notify")
async def alipay_notify(request):
    # 1. éªŒè¯ç­¾å
    if not verify_alipay_signature(request.form):
        return "fail"

    # 2. æ›´æ–°è®¢å•çŠ¶æ€
    trade_no = request.form['trade_no']
    trade_status = request.form['trade_status']

    if trade_status == 'TRADE_SUCCESS':
        update_order_status(trade_no, 'paid')

    return "success"
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. Expo Prebuildè­¦å‘Š

âš ï¸ **ä¸è¦éšæ„è¿è¡Œ** `npx expo prebuild --clean`

å¦‚æœå¿…é¡»è¿è¡Œï¼Œä¹‹åéœ€è¦ï¼š
1. é‡æ–°ä¿®æ”¹Podfileæ·»åŠ AlipaySDK
2. é‡æ–°åˆ›å»ºRNAlipayModuleæ–‡ä»¶
3. é‡æ–°è¿è¡Œæ·»åŠ è„šæœ¬
4. é‡æ–°é…ç½®Info.plist

### 2. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

- [ ] åç«¯é…ç½®çœŸå®çš„æ”¯ä»˜å®å•†æˆ·å·
- [ ] é…ç½®çœŸå®çš„åº”ç”¨ç§é’¥
- [ ] è®¾ç½®æ­£ç¡®çš„notify_url
- [ ] å®ç°ç­¾åéªŒè¯é€»è¾‘
- [ ] æ·»åŠ è®¢å•çŠ¶æ€æŸ¥è¯¢

### 3. æµ‹è¯•ç¯å¢ƒ

- [ ] ä½¿ç”¨æ”¯ä»˜å®æ²™ç®±ç¯å¢ƒ
- [ ] ä½¿ç”¨æµ‹è¯•å•†æˆ·å·
- [ ] å°é¢æµ‹è¯•ï¼ˆ0.01å…ƒï¼‰

---

## ğŸ‰ ç»“è®º

### âœ… å‰ç«¯æŠ€æœ¯é›†æˆï¼š100%å®Œæˆ

æ‰€æœ‰å‰ç«¯å’ŒiOSåŸç”Ÿä»£ç å·²å®Œå…¨é›†æˆå¹¶é…ç½®å®Œæˆã€‚æŒ‰ç…§ä½ åˆ†äº«çš„æ”¯ä»˜å®é›†æˆæµç¨‹å›¾ï¼Œå®¢æˆ·ç«¯ä¾§æ‰€æœ‰æŠ€æœ¯æ­¥éª¤å·²å…¨éƒ¨å®ç°ã€‚

### â³ ç­‰å¾…åç«¯é…ç½®

éœ€è¦åç«¯å¼€å‘å®Œæˆï¼š
1. ç”ŸæˆorderStringçš„æ¥å£
2. å¼‚æ­¥é€šçŸ¥å¤„ç†
3. è®¢å•çŠ¶æ€æ›´æ–°

### ğŸš€ å¯ä»¥å¼€å§‹æµ‹è¯•

ç°åœ¨å¯ä»¥ï¼š
1. è¿è¡Œ `npm run ios` å¯åŠ¨åº”ç”¨
2. æ·»åŠ æµ‹è¯•ä»£ç éªŒè¯åŸç”Ÿæ¨¡å—
3. ç­‰å¾…åç«¯æ¥å£readyåè¿›è¡Œå®Œæ•´æµ‹è¯•

---

**ğŸŠ æ­å–œï¼æ”¯ä»˜å®iOS SDKé›†æˆæŠ€æœ¯å·¥ä½œå·²å…¨éƒ¨å®Œæˆï¼**

ä»»ä½•é—®é¢˜è¯·æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£æˆ–è¿è¡Œæµ‹è¯•éªŒè¯ã€‚
