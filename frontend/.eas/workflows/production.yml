name: Production Release to TestFlight
description: 自动构建iOS版本并提交到TestFlight

on:
  workflow_dispatch:
    inputs:
      version_increment:
        description: '版本递增类型'
        type: choice
        options:
          - patch  # 1.0.7 → 1.0.8 (bug修复)
          - minor  # 1.0.7 → 1.1.0 (新功能)
          - major  # 1.0.7 → 2.0.0 (重大更新)
        default: patch

jobs:
  build_and_submit_ios:
    name: 构建并提交iOS版本
    runs-on: eas-build-medium
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        
      - name: 设置Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          
      - name: 安装依赖
        run: npm ci
        
      - name: 自动递增版本号
        run: |
          echo "递增版本号类型: ${{ inputs.version_increment }}"
          npm version ${{ inputs.version_increment }} --no-git-tag-version
          
          # 获取新版本号
          NEW_VERSION=$(node -p "require('./app.json').expo.version")
          NEW_BUILD_NUMBER=$(node -p "require('./app.json').expo.ios.buildNumber")
          
          echo "新版本: $NEW_VERSION"
          echo "新构建号: $NEW_BUILD_NUMBER"
          
          # 更新iOS原生版本号，避免版本冲突
          sed -i '' "s/<string>.*<\/string>/<string>$NEW_VERSION<\/string>/g" ios/PomeloX/Info.plist | grep -A1 CFBundleShortVersionString | head -2
          sed -i '' "s/<string>.*<\/string>/<string>$NEW_BUILD_NUMBER<\/string>/g" ios/PomeloX/Info.plist | grep -A1 CFBundleVersion | head -2
          
      - name: 构建iOS应用
        id: build
        run: |
          eas build --platform ios --profile production --non-interactive --wait
        env:
          EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
          
      - name: 提交到TestFlight
        run: |
          eas submit --platform ios --profile production --latest --non-interactive
        env:
          EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
          
      - name: 通知构建完成
        run: |
          echo "✅ 版本 $NEW_VERSION 已成功构建并提交到TestFlight!"
          echo "🍏 预计5-10分钟后在TestFlight中可用"