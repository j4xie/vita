# æ—¶åŒºåç§»å‚æ•°å®ç°æ–‡æ¡£

## ğŸ“‹ å®æ–½æ¦‚è¿°

ä¸ºå¿—æ„¿è€…ç­¾åˆ°/ç­¾é€€æ¥å£æ·»åŠ æ—¶åŒºåç§»å‚æ•°ï¼ˆ`timeOffset`ï¼‰ï¼Œç”¨äºè®°å½•ç”¨æˆ·æ“ä½œæ—¶ç›¸å¯¹äºåŒ—äº¬æ—¶é—´çš„æ—¶å·®ã€‚

**å®æ–½æ—¥æœŸ**: 2025å¹´10æœˆ19æ—¥
**æ¥å£å‚æ•°å**: `timeOffset`
**å‚æ•°æ ¼å¼**: æ•´æ•°å°æ—¶æ•°ï¼ˆè´Ÿæ•°è¡¨ç¤ºæ¯”åŒ—äº¬æ—¶é—´æ…¢ï¼Œæ­£æ•°è¡¨ç¤ºæ¯”åŒ—äº¬æ—¶é—´å¿«ï¼‰

## ğŸ¯ éœ€æ±‚èƒŒæ™¯

åç«¯éœ€è¦çŸ¥é“ç”¨æˆ·åœ¨ä¸åŒæ—¶åŒºæ“ä½œæ—¶ä¸åŒ—äº¬æ—¶é—´çš„æ—¶å·®ï¼Œç”¨äºï¼š
- å‡†ç¡®è®°å½•å…¨çƒç”¨æˆ·çš„ç­¾åˆ°/ç­¾é€€æ—¶é—´
- å¤„ç†è·¨æ—¶åŒºçš„å·¥æ—¶ç»Ÿè®¡
- æä¾›æ›´å‡†ç¡®çš„æ—¶é—´æ•°æ®åˆ†æ

## âœ… å®æ–½å†…å®¹

### 1. æ–°å¢æ—¶åŒºå·¥å…·å‡½æ•°

**æ–‡ä»¶**: `/Users/jietaoxie/pomeloX/frontend/src/utils/timezoneHelper.ts`

```typescript
/**
 * è·å–å½“å‰è®¾å¤‡æ—¶åŒºä¸åŒ—äº¬æ—¶é—´çš„æ—¶å·®ï¼ˆå°æ—¶ï¼‰
 * @returns æ—¶å·®ï¼ˆå°æ—¶ï¼‰ï¼Œè´Ÿæ•°è¡¨ç¤ºæ¯”åŒ—äº¬æ—¶é—´æ…¢ï¼Œæ­£æ•°è¡¨ç¤ºæ¯”åŒ—äº¬æ—¶é—´å¿«
 */
export const getTimeOffsetFromBeijing = (): number
```

**åŠŸèƒ½**:
- ä½¿ç”¨iOSåŸç”ŸAPI `new Date().getTimezoneOffset()` è·å–UTCåç§»
- è‡ªåŠ¨å¤„ç†å¤ä»¤æ—¶è°ƒæ•´
- è®¡ç®—ä¸åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰çš„æ—¶å·®
- å¼€å‘ç¯å¢ƒä¸‹è¾“å‡ºè¯¦ç»†è°ƒè¯•ä¿¡æ¯

**æµ‹è¯•ç»“æœ**:
```
æœ¬åœ°æ—¶åŒº: UTC-4
åŒ—äº¬æ—¶åŒº: UTC+8
æ—¶å·®: -12å°æ—¶
APIå‚æ•°: timeOffset=-12
```

### 2. æ›´æ–°APIæ¥å£

**æ–‡ä»¶**: `/Users/jietaoxie/pomeloX/frontend/src/services/volunteerAPI.ts`

#### 2.1 æ ¸å¿ƒAPIå‡½æ•°

```typescript
export const volunteerSignRecord = async (
  userId: number,
  type: 1 | 2,
  operateUserId: number,
  operateLegalName: string,
  startTime?: string,
  endTime?: string,
  recordId?: number,
  remark?: string,
  autoApprovalStatus?: 1,
  timeOffset?: number,  // ğŸ†• æ–°å¢å‚æ•°
): Promise<APIResponse>
```

**ä¿®æ”¹ä½ç½®**: ç¬¬338-349è¡Œï¼ˆå‡½æ•°ç­¾åï¼‰ã€ç¬¬386-397è¡Œï¼ˆè¯·æ±‚ä½“æ„å»ºï¼‰

#### 2.2 é«˜å±‚å°è£…å‡½æ•°

æ‰€æœ‰è°ƒç”¨ `volunteerSignRecord` çš„å‡½æ•°éƒ½å·²æ›´æ–°ï¼š

1. **`performVolunteerCheckIn`** (ç¬¬910-1045è¡Œ)
   - ç­¾åˆ°æ—¶è‡ªåŠ¨è·å–å¹¶ä¼ é€’æ—¶åŒºåç§»

2. **`performVolunteerCheckOut`** (ç¬¬1050-1436è¡Œ)
   - ç­¾é€€æ—¶è‡ªåŠ¨è·å–å¹¶ä¼ é€’æ—¶åŒºåç§»
   - åŒ…å«æ­£å¸¸ç­¾é€€å’Œè¶…æ—¶ç­¾é€€ä¸¤ä¸ªåˆ†æ”¯

3. **`smartVolunteerSignOut`** (ç¬¬593-748è¡Œ)
   - æ™ºèƒ½ç­¾é€€æ—¶ä¼ é€’æ—¶åŒºå‚æ•°
   - æ”¯æŒè‡ªåŠ¨å®¡æ ¸æµç¨‹

4. **`performTimeEntry`** (ç¬¬1739-1900è¡Œ)
   - è¡¥å½•å·¥æ—¶æ—¶ä¼ é€’æ—¶åŒºå‚æ•°
   - ç­¾åˆ°å’Œç­¾é€€ä¸¤æ¬¡è°ƒç”¨éƒ½åŒ…å«æ—¶åŒºä¿¡æ¯

5. **`forceResetVolunteerStatus`** (ç¬¬1463-1510è¡Œ)
   - å¼ºåˆ¶é‡ç½®çŠ¶æ€æ—¶ä¼ é€’æ—¶åŒºå‚æ•°

6. **`autoCheckoutOvertimeUsers`** (ç¬¬1641-1727è¡Œ)
   - è‡ªåŠ¨ç­¾é€€è¶…æ—¶ç”¨æˆ·æ—¶ä¼ é€’æ—¶åŒºå‚æ•°

## ğŸ“Š æ—¶åŒºè®¡ç®—é€»è¾‘

### è®¡ç®—å…¬å¼
```
timeOffset = æœ¬åœ°UTCåç§» - åŒ—äº¬UTCåç§»(+8)
```

### ç¤ºä¾‹

| ç”¨æˆ·æ—¶åŒº | UTCåç§» | æ—¶å·®è®¡ç®— | timeOffset | è¯´æ˜ |
|---------|---------|---------|------------|------|
| ç¾å›½æ´›æ‰çŸ¶ | -8 | -8 - 8 | -16 | æ¯”åŒ—äº¬æ—¶é—´æ…¢16å°æ—¶ |
| ç¾å›½çº½çº¦ | -5 | -5 - 8 | -13 | æ¯”åŒ—äº¬æ—¶é—´æ…¢13å°æ—¶ |
| è‹±å›½ä¼¦æ•¦ | 0 | 0 - 8 | -8 | æ¯”åŒ—äº¬æ—¶é—´æ…¢8å°æ—¶ |
| ä¸­å›½ä¸Šæµ· | +8 | 8 - 8 | 0 | ä¸åŒ—äº¬æ—¶é—´ç›¸åŒ |
| æ—¥æœ¬ä¸œäº¬ | +9 | 9 - 8 | +1 | æ¯”åŒ—äº¬æ—¶é—´å¿«1å°æ—¶ |
| æ¾³æ´²æ‚‰å°¼ | +10 | 10 - 8 | +2 | æ¯”åŒ—äº¬æ—¶é—´å¿«2å°æ—¶ |

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### iOSæ—¶åŒºAPI
- **è·å–UTCåç§»**: `new Date().getTimezoneOffset()`
  - è¿”å›å€¼å•ä½ï¼šåˆ†é’Ÿ
  - ç¬¦å·ç›¸åï¼ˆUTC+8è¿”å›-480ï¼‰
  - éœ€è¦é™¤ä»¥60å¹¶å–åå¾—åˆ°å°æ—¶æ•°

- **è·å–æ—¶åŒºåç§°**: `Intl.DateTimeFormat().resolvedOptions().timeZone`
  - è¿”å›æ—¶åŒºæ ‡è¯†ç¬¦ï¼ˆå¦‚ "America/Los_Angeles"ï¼‰
  - è‡ªåŠ¨å¤„ç†å¤ä»¤æ—¶

### è°ƒè¯•æ—¥å¿—

å¼€å‘ç¯å¢ƒä¸‹ä¼šè¾“å‡ºè¯¦ç»†çš„æ—¶åŒºä¿¡æ¯ï¼š
```javascript
console.log('â° [TIMEZONE] æ—¶åŒºä¿¡æ¯:', {
  timezoneName: 'America/New_York',
  localOffsetMinutes: -300,
  localOffsetHours: -5,
  beijingOffsetHours: 8,
  timeOffset: -13,
  description: 'æ¯”åŒ—äº¬æ—¶é—´æ…¢13å°æ—¶'
});
```

## âœ… æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•
```bash
node -e "
const getTimeOffsetFromBeijing = () => {
  const localOffsetMinutes = -new Date().getTimezoneOffset();
  const localOffsetHours = localOffsetMinutes / 60;
  const beijingOffsetHours = 8;
  return localOffsetHours - beijingOffsetHours;
};
console.log('timeOffset:', getTimeOffsetFromBeijing());
"
```

### é›†æˆæµ‹è¯•å»ºè®®
1. **iOSæ¨¡æ‹Ÿå™¨æµ‹è¯•**
   - åœ¨æ¨¡æ‹Ÿå™¨è®¾ç½®ä¸­åˆ‡æ¢ä¸åŒæ—¶åŒº
   - éªŒè¯ç­¾åˆ°/ç­¾é€€è¯·æ±‚åŒ…å«æ­£ç¡®çš„timeOffsetå‚æ•°

2. **çœŸæœºæµ‹è¯•**
   - åœ¨ä¸åŒå›½å®¶/åœ°åŒºæµ‹è¯•
   - éªŒè¯å¤ä»¤æ—¶è°ƒæ•´æ˜¯å¦æ­£ç¡®å¤„ç†

3. **åç«¯éªŒè¯**
   - æ£€æŸ¥åç«¯æ¥æ”¶åˆ°çš„timeOffsetå‚æ•°
   - éªŒè¯æ—¶é—´è®°å½•çš„å‡†ç¡®æ€§

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç­¾åˆ°
```typescript
import { getTimeOffsetFromBeijing } from '../utils/timezoneHelper';

// è·å–æ—¶åŒºåç§»
const timeOffset = getTimeOffsetFromBeijing();
// è¾“å‡ºï¼š-12 (ç¾å›½ä¸œéƒ¨æ—¶é—´)

// è°ƒç”¨ç­¾åˆ°API
await volunteerSignRecord(
  userId,
  1, // ç­¾åˆ°
  operateUserId,
  operateLegalName,
  currentTime,
  undefined,
  undefined,
  undefined,
  undefined,
  timeOffset // ä¼ é€’æ—¶åŒºåç§»
);
```

### APIè¯·æ±‚ç¤ºä¾‹
```
POST /app/hour/signRecord
Content-Type: application/x-www-form-urlencoded

userId=123&type=1&operateUserId=456&operateLegalName=å¼ ä¸‰&startTime=2025-10-19 14:30:00&timeOffset=-12
```

## ğŸ” å½±å“èŒƒå›´

### ç›´æ¥å½±å“
- âœ… å¿—æ„¿è€…ç­¾åˆ°åŠŸèƒ½
- âœ… å¿—æ„¿è€…ç­¾é€€åŠŸèƒ½
- âœ… æ™ºèƒ½ç­¾é€€ï¼ˆè‡ªåŠ¨å®¡æ ¸ï¼‰
- âœ… è¡¥å½•å·¥æ—¶åŠŸèƒ½
- âœ… å¼ºåˆ¶é‡ç½®çŠ¶æ€
- âœ… è‡ªåŠ¨ç­¾é€€è¶…æ—¶ç”¨æˆ·

### æ— å½±å“
- âœ“ æŸ¥è¯¢æ¥å£ï¼ˆä»…è¯»å–æ•°æ®ï¼‰
- âœ“ ç»Ÿè®¡æ¥å£
- âœ“ å†å²è®°å½•æŸ¥è¯¢

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‚æ•°å¯é€‰æ€§**
   - timeOffsetå‚æ•°ä¸ºå¯é€‰å‚æ•°
   - å¦‚æœæœªæä¾›ï¼Œåç«¯åº”ä½¿ç”¨é»˜è®¤å¤„ç†é€»è¾‘

2. **å¤ä»¤æ—¶å¤„ç†**
   - iOSè‡ªåŠ¨å¤„ç†å¤ä»¤æ—¶è°ƒæ•´
   - æ— éœ€æ‰‹åŠ¨è®¡ç®—å¤ä»¤æ—¶åç§»

3. **ç²¾åº¦**
   - å½“å‰å®ç°ç²¾åº¦ä¸ºå°æ—¶ï¼ˆæ•´æ•°ï¼‰
   - å¯¹äºåŠå°æ—¶æ—¶åŒºï¼ˆå¦‚å°åº¦UTC+5:30ï¼‰ï¼Œä¼šæœ‰ç²¾åº¦æŸå¤±

4. **å…¼å®¹æ€§**
   - æ‰€æœ‰ç°æœ‰è°ƒç”¨éƒ½å·²æ›´æ–°
   - ä¸å½±å“å·²æœ‰çš„æ—¶é—´å¤„ç†é€»è¾‘

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ—¶åŒºå·¥å…·å‡½æ•°æºç ](../src/utils/timezoneHelper.ts)
- [å¿—æ„¿è€…APIæºç ](../src/services/volunteerAPI.ts)
- [ç»Ÿä¸€æ—¶é—´æœåŠ¡](../src/utils/UnifiedTimeService.ts)

## ğŸ‰ å®ŒæˆçŠ¶æ€

- âœ… æ—¶åŒºå·¥å…·å‡½æ•°åˆ›å»º
- âœ… APIæ¥å£å‚æ•°æ·»åŠ 
- âœ… æ‰€æœ‰è°ƒç”¨ç‚¹æ›´æ–°
- âœ… TypeScriptç±»å‹æ£€æŸ¥é€šè¿‡
- âœ… å•å…ƒæµ‹è¯•éªŒè¯
- âœ… æ–‡æ¡£ç¼–å†™å®Œæˆ

**å®æ–½äºº**: Claude Code
**å®¡æ ¸çŠ¶æ€**: å¾…ç”¨æˆ·éªŒè¯
**åç»­å·¥ä½œ**: çœŸæœºæµ‹è¯• + åç«¯è”è°ƒ
