<!DOCTYPE html>
<html>
<head>
    <title>活动报名签到问题诊断</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; font-family: monospace; }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #080; }
        input, button { padding: 8px; margin: 5px; }
        input[type="text"] { width: 300px; }
        button { background: #007cba; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a87; }
    </style>
</head>
<body>
    <div class="container">
        <h1>活动报名签到问题诊断工具</h1>
        
        <div class="test-section">
            <h3>1. 设置Token</h3>
            <input type="text" id="tokenInput" placeholder="请输入您的Bearer Token">
            <button onclick="setToken()">设置Token</button>
            <div id="tokenStatus"></div>
        </div>
        
        <div class="test-section">
            <h3>2. 获取用户信息</h3>
            <button onclick="getUserInfo()">获取用户信息</button>
            <div id="userInfoResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. 获取活动列表</h3>
            <button onclick="getActivityList()">获取活动列表</button>
            <div id="activityListResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>4. 获取用户报名活动</h3>
            <button onclick="getUserActivities()">获取用户报名的活动</button>
            <div id="userActivitiesResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>5. 测试UCI活动签到</h3>
            <input type="number" id="activityIdInput" placeholder="活动ID (自动检测UCI活动)">
            <button onclick="testSignIn()">测试签到</button>
            <div id="signInResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>6. 综合诊断</h3>
            <button onclick="runFullDiagnosis()">运行完整诊断</button>
            <div id="diagnosisResult" class="result"></div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://www.vitaglobal.icu';
        let userToken = '';
        let currentUserId = null;
        let uciActivityId = null;

        function setToken() {
            userToken = document.getElementById('tokenInput').value.trim();
            if (userToken) {
                document.getElementById('tokenStatus').innerHTML = '<span style="color: green;">Token已设置</span>';
            } else {
                document.getElementById('tokenStatus').innerHTML = '<span style="color: red;">请输入有效的Token</span>';
            }
        }

        async function makeRequest(endpoint, params = {}, method = 'GET') {
            if (!userToken) {
                return { success: false, error: '请先设置Token' };
            }

            const url = new URL(endpoint, BASE_URL);
            
            let requestOptions = {
                method: method,
                headers: {
                    'Authorization': `Bearer ${userToken}`,
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            };
            
            if (method === 'GET' && Object.keys(params).length > 0) {
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            } else if (method === 'POST') {
                const formData = new URLSearchParams();
                Object.keys(params).forEach(key => formData.append(key, params[key]));
                requestOptions.body = formData;
            }
            
            try {
                const response = await fetch(url, requestOptions);
                const data = await response.json();
                return { success: true, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function getUserInfo() {
            const result = await makeRequest('/app/user/info');
            const resultDiv = document.getElementById('userInfoResult');
            
            if (result.success) {
                currentUserId = result.data?.data?.userId;
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = '错误: ' + (result.error || '无法获取用户信息');
            }
        }

        async function getActivityList() {
            if (!currentUserId) {
                alert('请先获取用户信息');
                return;
            }

            const result = await makeRequest('/app/activity/list', { 
                userId: currentUserId, 
                pageNum: 1, 
                pageSize: 20 
            });
            
            const resultDiv = document.getElementById('activityListResult');
            
            if (result.success) {
                // 查找UCI活动
                const activities = result.data?.data?.rows || [];
                const uciActivity = activities.find(activity => 
                    activity.activityName && activity.activityName.includes('UCI')
                );
                
                if (uciActivity) {
                    uciActivityId = uciActivity.activityId;
                    document.getElementById('activityIdInput').value = uciActivityId;
                }
                
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = '错误: ' + (result.error || '无法获取活动列表');
            }
        }

        async function getUserActivities() {
            if (!currentUserId) {
                alert('请先获取用户信息');
                return;
            }

            const result = await makeRequest('/app/activity/userActivitylist', { userId: currentUserId });
            const resultDiv = document.getElementById('userActivitiesResult');
            
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.textContent = JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = '错误: ' + (result.error || '无法获取用户活动');
            }
        }

        async function testSignIn() {
            if (!currentUserId) {
                alert('请先获取用户信息');
                return;
            }

            const activityId = document.getElementById('activityIdInput').value || uciActivityId;
            if (!activityId) {
                alert('请输入活动ID或先获取活动列表');
                return;
            }

            const result = await makeRequest('/app/activity/signIn', { 
                activityId: activityId, 
                userId: currentUserId 
            });
            
            const resultDiv = document.getElementById('signInResult');
            
            if (result.success) {
                if (result.data?.code === 200) {
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.className = 'result error';
                }
                resultDiv.textContent = JSON.stringify(result.data, null, 2);
            } else {
                resultDiv.className = 'result error';
                resultDiv.textContent = '错误: ' + (result.error || '签到失败');
            }
        }

        async function runFullDiagnosis() {
            const resultDiv = document.getElementById('diagnosisResult');
            resultDiv.textContent = '正在运行完整诊断...\n';
            
            let report = '=== 活动报名签到问题诊断报告 ===\n\n';
            
            // 1. 用户信息
            report += '1. 用户信息检查:\n';
            const userInfo = await makeRequest('/app/user/info');
            if (userInfo.success) {
                currentUserId = userInfo.data?.data?.userId;
                report += `   ✓ 用户ID: ${currentUserId}\n`;
                report += `   ✓ 用户名: ${userInfo.data?.data?.userName}\n`;
            } else {
                report += `   ✗ 获取用户信息失败: ${userInfo.error}\n`;
                resultDiv.textContent = report;
                return;
            }
            
            // 2. 活动列表
            report += '\n2. 活动列表检查:\n';
            const activities = await makeRequest('/app/activity/list', { 
                userId: currentUserId, 
                pageNum: 1, 
                pageSize: 20 
            });
            
            if (activities.success) {
                const activityList = activities.data?.data?.rows || [];
                const uciActivities = activityList.filter(activity => 
                    activity.activityName && activity.activityName.includes('UCI')
                );
                
                report += `   ✓ 总活动数: ${activityList.length}\n`;
                report += `   ✓ UCI相关活动数: ${uciActivities.length}\n`;
                
                uciActivities.forEach(activity => {
                    report += `   - ${activity.activityName} (ID: ${activity.activityId})\n`;
                });
                
                if (uciActivities.length > 0) {
                    uciActivityId = uciActivities[0].activityId;
                }
            } else {
                report += `   ✗ 获取活动列表失败: ${activities.error}\n`;
            }
            
            // 3. 用户报名状态
            report += '\n3. 用户报名状态检查:\n';
            const userActivities = await makeRequest('/app/activity/userActivitylist', { userId: currentUserId });
            
            if (userActivities.success) {
                const enrolledActivities = userActivities.data?.data || [];
                report += `   ✓ 已报名活动数: ${enrolledActivities.length}\n`;
                
                const uciEnrolled = enrolledActivities.filter(activity => 
                    activity.activityName && activity.activityName.includes('UCI')
                );
                
                report += `   ✓ 已报名UCI活动数: ${uciEnrolled.length}\n`;
                
                uciEnrolled.forEach(activity => {
                    report += `   - ${activity.activityName} (ID: ${activity.activityId})\n`;
                    report += `     报名状态: ${activity.signStatus === 1 ? '已签到' : '未签到'}\n`;
                });
            } else {
                report += `   ✗ 获取用户报名状态失败: ${userActivities.error}\n`;
            }
            
            // 4. 签到测试
            if (uciActivityId) {
                report += '\n4. 签到功能测试:\n';
                const signInTest = await makeRequest('/app/activity/signIn', { 
                    activityId: uciActivityId, 
                    userId: currentUserId 
                });
                
                if (signInTest.success) {
                    report += `   ✓ 签到API调用成功\n`;
                    report += `   响应码: ${signInTest.data?.code}\n`;
                    report += `   响应消息: ${signInTest.data?.msg}\n`;
                    
                    if (signInTest.data?.code === 200) {
                        report += `   ✓ 签到成功\n`;
                    } else {
                        report += `   ✗ 签到失败: ${signInTest.data?.msg}\n`;
                    }
                } else {
                    report += `   ✗ 签到API调用失败: ${signInTest.error}\n`;
                }
            } else {
                report += '\n4. 签到功能测试:\n';
                report += '   ✗ 未找到UCI活动ID，无法测试签到\n';
            }
            
            // 5. 问题诊断
            report += '\n5. 问题诊断结论:\n';
            
            if (userActivities.success) {
                const enrolledActivities = userActivities.data?.data || [];
                const uciEnrolled = enrolledActivities.filter(activity => 
                    activity.activityName && activity.activityName.includes('UCI')
                );
                
                if (uciEnrolled.length === 0) {
                    report += '   ⚠️  问题发现: 用户未报名任何UCI活动\n';
                    report += '   建议: 检查报名流程是否正常工作\n';
                } else {
                    report += '   ✓ 用户已报名UCI活动\n';
                    if (uciActivityId) {
                        report += '   建议: 检查签到时活动ID是否匹配\n';
                    }
                }
            }
            
            resultDiv.className = 'result';
            resultDiv.textContent = report;
        }
    </script>
</body>
</html>