# å¿—æ„¿è€…ç­¾åˆ°ç­¾é€€åŠŸèƒ½å®Œæ•´å®¡è®¡æŠ¥å‘Š

## ğŸ“‹ å®¡è®¡æ¦‚å†µ

**å®¡è®¡æ—¶é—´**: 2025-08-25
**å®¡è®¡èŒƒå›´**: å¿—æ„¿è€…ç­¾åˆ°ç­¾é€€åŠŸèƒ½çš„å®Œæ•´æ•°æ®æµå’Œæ½œåœ¨é—®é¢˜åˆ†æ
**æ ¸å¿ƒæ–‡ä»¶**: SchoolDetailScreen.tsx, volunteerAPI.ts, UserContext.tsx

---

## âœ… åŠŸèƒ½å®Œæ•´æ€§æ£€æŸ¥

### 1. **æ ¸å¿ƒåŠŸèƒ½å®ç°çŠ¶æ€**
- âœ… å¿—æ„¿è€…ç­¾åˆ°åŠŸèƒ½ (`handleCheckIn`)
- âœ… å¿—æ„¿è€…ç­¾é€€åŠŸèƒ½ (`handleCheckOut`) 
- âœ… å®æ—¶å·¥ä½œæ—¶é•¿è®¡ç®— (`calculateWorkingDuration`)
- âœ… ç­¾åˆ°çŠ¶æ€æœ¬åœ°æŒä¹…åŒ– (`saveCheckinState`, `loadCheckinState`)
- âœ… APIé”™è¯¯é™çº§å¤„ç† (ç¦»çº¿æ¨¡å¼æ”¯æŒ)
- âœ… ç”¨æˆ·æƒé™æ£€æŸ¥ (`permissions.canCheckInOut()`)

### 2. **APIé›†æˆå®Œæ•´æ€§**
- âœ… `volunteerSignRecord` - ç­¾åˆ°ç­¾é€€APIè°ƒç”¨
- âœ… `getLastVolunteerRecord` - è·å–æœ€åç­¾åˆ°è®°å½•
- âœ… `getCurrentToken` - è®¤è¯tokenè·å–
- âœ… `getCurrentUserId` - å½“å‰ç”¨æˆ·IDè·å–
- âœ… UserContexté›†æˆ - ç”¨æˆ·ä¿¡æ¯å’Œæƒé™è·å–

---

## âš ï¸ æ½œåœ¨é—®é¢˜åˆ†æ

### **ğŸ”´ é«˜é£é™©é—®é¢˜**

#### 1. **ç”¨æˆ·IDæ˜ å°„ä¸ä¸€è‡´é£é™©**
**ä½ç½®**: `handleCheckIn` Line 436, `handleCheckOut` Line 554
```typescript
const userId = volunteer?.userId || parseInt(volunteerId);
```
**é—®é¢˜**: å½“`volunteer?.userId`ä¸ºundefinedæ—¶ï¼Œä½¿ç”¨`parseInt(volunteerId)`å¯èƒ½å¯¼è‡´é”™è¯¯çš„ç”¨æˆ·ID
**å½±å“**: å¯èƒ½ç»™é”™è¯¯çš„ç”¨æˆ·è¿›è¡Œç­¾åˆ°æ“ä½œ
**å»ºè®®ä¿®å¤**:
```typescript
const userId = volunteer?.userId;
if (!userId || typeof userId !== 'number' || userId <= 0) {
  console.error('æ— æ•ˆçš„ç”¨æˆ·ID:', { volunteerId, userId });
  Alert.alert('é”™è¯¯', 'æ— æ³•è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼Œè¯·é‡è¯•');
  return;
}
```

#### 2. **ç­¾é€€è®°å½•IDè·å–å¤±è´¥çš„å¤„ç†ä¸å®Œæ•´**
**ä½ç½®**: `handleCheckOut` Line 563-582
**é—®é¢˜**: å½“`getLastVolunteerRecord`å¤±è´¥æ—¶ï¼Œåº”è¯¥æ›´æ˜ç¡®åœ°å‘ŠçŸ¥ç”¨æˆ·å…·ä½“åŸå› 
**å½±å“**: ç”¨æˆ·å¯èƒ½ä¸çŸ¥é“ä¸ºä»€ä¹ˆç­¾é€€å¤±è´¥
**å»ºè®®ä¼˜åŒ–**: æ·»åŠ æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯æç¤º

#### 3. **è®¤è¯å¤±æ•ˆæ—¶çš„ç”¨æˆ·ä½“éªŒ**
**ä½ç½®**: `volunteerAPI.ts` Line 304-311
**é—®é¢˜**: å½“tokenè¿‡æœŸ(401/403)æ—¶ï¼Œç”¨æˆ·å¯èƒ½ä¸çŸ¥é“éœ€è¦é‡æ–°ç™»å½•
**å»ºè®®**: æ·»åŠ è‡ªåŠ¨è·³è½¬ç™»å½•é¡µé¢çš„é€»è¾‘

### **ğŸŸ¡ ä¸­ç­‰é£é™©é—®é¢˜**

#### 4. **æœ¬åœ°çŠ¶æ€ä¸åç«¯æ•°æ®ä¸ä¸€è‡´**
**ä½ç½®**: `mergeVolunteerStates` Line 184-203
**é—®é¢˜**: æœ¬åœ°ç¼“å­˜çš„ç­¾åˆ°çŠ¶æ€å¯èƒ½ä¸åç«¯å®é™…çŠ¶æ€ä¸åŒ¹é…
**å½±å“**: UIæ˜¾ç¤ºå¯èƒ½ä¸å®é™…çŠ¶æ€ä¸ç¬¦
**å»ºè®®**: å®šæœŸåˆ·æ–°åç«¯çŠ¶æ€ï¼Œåœ¨å…³é”®æ“ä½œå‰éªŒè¯çŠ¶æ€ä¸€è‡´æ€§

#### 5. **ç½‘ç»œè¶…æ—¶å¤„ç†ä¸å®Œå–„**
**ä½ç½®**: `volunteerAPI.ts` - æ‰€æœ‰APIè°ƒç”¨
**é—®é¢˜**: æ²¡æœ‰è®¾ç½®æ˜ç¡®çš„ç½‘ç»œè¶…æ—¶æ—¶é—´
**å»ºè®®**: æ·»åŠ fetch timeouté…ç½®

#### 6. **æ“ä½œæƒé™æ£€æŸ¥æ—¶æœº**
**ä½ç½®**: UIå±‚é¢ç¼ºå°‘æŒ‰é’®æ˜¾ç¤ºå‰çš„æƒé™æ£€æŸ¥
**é—®é¢˜**: éæˆæƒç”¨æˆ·å¯èƒ½çœ‹åˆ°ç­¾åˆ°æŒ‰é’®ä½†æ“ä½œå¤±è´¥
**å»ºè®®**: åœ¨æ¸²æŸ“æŒ‰é’®å‰æ£€æŸ¥`permissions.canCheckInOut()`

### **ğŸŸ¢ ä½é£é™©é—®é¢˜**

#### 7. **æ—¶é—´æ ¼å¼æ˜¾ç¤ºä¸ä¸€è‡´**
**ä½ç½®**: `formatChineseDateTime` Line 751-777
**é—®é¢˜**: ä¸åŒæ—¶åŒºå¯èƒ½å¯¼è‡´æ—¶é—´æ˜¾ç¤ºé—®é¢˜
**å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨UTCæ—¶é—´æˆ–æ˜ç¡®æ—¶åŒºå¤„ç†

#### 8. **æ—¥å¿—ä¿¡æ¯è¿‡äºè¯¦ç»†**
**ä½ç½®**: æ•´ä¸ªæ–‡ä»¶ä¸­æœ‰å¤§é‡console.log
**é—®é¢˜**: ç”Ÿäº§ç¯å¢ƒå¯èƒ½æš´éœ²æ•æ„Ÿä¿¡æ¯
**å»ºè®®**: ä½¿ç”¨æ—¥å¿—çº§åˆ«æ§åˆ¶ï¼Œç”Ÿäº§ç¯å¢ƒåˆ é™¤æ•æ„Ÿæ—¥å¿—

---

## ğŸ”§ ä»£ç é€»è¾‘æ£€æŸ¥

### **æ•°æ®æµåˆ†æ**

1. **ç­¾åˆ°æµç¨‹** âœ…
   ```
   ç”¨æˆ·ç‚¹å‡»ç­¾åˆ° â†’ æƒé™æ£€æŸ¥ â†’ è·å–ç”¨æˆ·ä¿¡æ¯ â†’ è°ƒç”¨API â†’ æ›´æ–°æœ¬åœ°çŠ¶æ€ â†’ åˆ·æ–°æ•°æ®
   ```

2. **ç­¾é€€æµç¨‹** âœ… (æœ‰é£é™©ç‚¹)
   ```
   ç”¨æˆ·ç‚¹å‡»ç­¾é€€ â†’ è·å–æœ€åè®°å½•ID â†’ è°ƒç”¨API â†’ æ›´æ–°æœ¬åœ°çŠ¶æ€ â†’ åˆ·æ–°æ•°æ®
   ```

3. **é™çº§å¤„ç†** âœ…
   ```
   APIå¤±è´¥ â†’ æœ¬åœ°çŠ¶æ€æ›´æ–° â†’ ç”¨æˆ·å‹å¥½æç¤º â†’ åå°é‡è¯•æœºåˆ¶
   ```

### **è¾¹ç•Œæƒ…å†µå¤„ç†**

- âœ… ç½‘ç»œæ–­å¼€æ—¶çš„ç¦»çº¿å¤„ç†
- âœ… Tokenè¿‡æœŸæ—¶çš„é™çº§å¤„ç†  
- âš ï¸ é‡å¤ç­¾åˆ°çš„é˜²æŠ¤ (éƒ¨åˆ†å®ç°)
- âš ï¸ å¼‚å¸¸æ•°æ®çš„å®¹é”™å¤„ç† (éƒ¨åˆ†å®ç°)
- âœ… ç”¨æˆ·æƒé™ä¸è¶³çš„å¤„ç†

---

## ğŸ›¡ï¸ å®‰å…¨æ€§æ£€æŸ¥

### **è®¤è¯å®‰å…¨** âœ…
- Tokenæ­£ç¡®ä¼ é€’åˆ°APIè°ƒç”¨
- ç”¨æˆ·æƒé™åœ¨æ“ä½œå‰æ£€æŸ¥
- æ•æ„Ÿæ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™

### **æ•°æ®å®‰å…¨** âš ï¸
- ç”¨æˆ·IDéªŒè¯éœ€è¦åŠ å¼º
- æ“ä½œè®°å½•çš„å®¡è®¡æ—¥å¿—å®Œæ•´
- æœ¬åœ°å­˜å‚¨æ•°æ®åŠ å¯†å»ºè®®(AsyncStorageæ˜æ–‡å­˜å‚¨)

---

## ğŸ“± UI/UXçŠ¶æ€ç®¡ç†

### **æŒ‰é’®çŠ¶æ€é€»è¾‘** âœ…
```typescript
// ç­¾åˆ°æŒ‰é’®æ˜¾ç¤ºæ¡ä»¶
(item?.checkInStatus === 'not_checked_in' || item?.checkInStatus === 'checked_out')

// ç­¾é€€æŒ‰é’®æ˜¾ç¤ºæ¡ä»¶  
item?.checkInStatus === 'checked_in'
```

### **å®æ—¶çŠ¶æ€æ›´æ–°** âœ…
- æ¯ç§’æ›´æ–°å·¥ä½œæ—¶é•¿è®¡æ—¶å™¨
- æ“ä½œåç«‹å³åˆ·æ–°å¿—æ„¿è€…åˆ—è¡¨
- æœ¬åœ°çŠ¶æ€ä¸UIåŒæ­¥

### **é”™è¯¯çŠ¶æ€å¤„ç†** âœ…
- APIå¤±è´¥æ—¶çš„ç”¨æˆ·æç¤º
- ç½‘ç»œé”™è¯¯çš„é™çº§æ˜¾ç¤º
- æƒé™ä¸è¶³çš„å‹å¥½æç¤º

---

## ğŸ” ä¾èµ–æ£€æŸ¥

### **æ ¸å¿ƒä¾èµ–çŠ¶æ€**
- âœ… React Native AsyncStorage - æ­£å¸¸å·¥ä½œ
- âœ… UserContextæƒé™ç³»ç»Ÿ - å®Œæ•´å®ç°
- âœ… i18nç¿»è¯‘ç³»ç»Ÿ - ç¿»è¯‘é”®å®Œæ•´
- âœ… SafeTextç»„ä»¶ - é˜²æ­¢æ¸²æŸ“é”™è¯¯

### **APIä¾èµ–å¥åº·åº¦**
- âœ… volunteerAPIæœåŠ¡ - å®Œæ•´å®ç°
- âœ… authAPIè®¤è¯æœåŠ¡ - tokenç®¡ç†æ­£å¸¸
- âœ… åç«¯APIæ¥å£ - å·²é…ç½®å¹¶æµ‹è¯•

---

## ğŸ¯ ä¼˜å…ˆä¿®å¤å»ºè®®

### **ç´§æ€¥ä¿®å¤ (P0)**
1. åŠ å¼ºç”¨æˆ·IDéªŒè¯é€»è¾‘ï¼Œé˜²æ­¢é”™è¯¯æ“ä½œ
2. ä¼˜åŒ–ç­¾é€€è®°å½•IDè·å–å¤±è´¥çš„é”™è¯¯å¤„ç†
3. æ·»åŠ é‡å¤ç‚¹å‡»çš„é˜²æŠ–ä¿æŠ¤

### **é‡è¦ä¿®å¤ (P1)**  
4. å®ç°è®¤è¯å¤±æ•ˆæ—¶çš„è‡ªåŠ¨é‡æ–°ç™»å½•
5. åŠ å¼ºæœ¬åœ°çŠ¶æ€ä¸åç«¯çŠ¶æ€çš„ä¸€è‡´æ€§æ£€æŸ¥
6. å®Œå–„ç½‘ç»œè¶…æ—¶å’Œé‡è¯•æœºåˆ¶

### **ä¼˜åŒ–å»ºè®® (P2)**
7. ç»Ÿä¸€æ—¶é—´æ ¼å¼å¤„ç†
8. ä¼˜åŒ–ç”Ÿäº§ç¯å¢ƒæ—¥å¿—è¾“å‡º
9. åŠ å¼ºæ•°æ®åŠ å¯†ä¿æŠ¤

---

## ğŸ§ª å»ºè®®æµ‹è¯•åœºæ™¯

### **åŠŸèƒ½æµ‹è¯•**
- [ ] æ­£å¸¸ç­¾åˆ°ç­¾é€€æµç¨‹
- [ ] ç½‘ç»œæ–­å¼€æ—¶çš„ç¦»çº¿æ“ä½œ
- [ ] å¿«é€Ÿé‡å¤ç‚¹å‡»çš„é˜²æŠ¤
- [ ] ä¸åŒæƒé™ç”¨æˆ·çš„æ“ä½œé™åˆ¶

### **è¾¹ç•Œæµ‹è¯•**  
- [ ] Tokenè¿‡æœŸæ—¶çš„å¤„ç†
- [ ] æœåŠ¡å™¨è¿”å›å¼‚å¸¸æ•°æ®çš„å¤„ç†
- [ ] æœ¬åœ°å­˜å‚¨ç©ºé—´ä¸è¶³çš„å¤„ç†
- [ ] ç³»ç»Ÿæ—¶é—´å¼‚å¸¸çš„å¤„ç†

### **å‹åŠ›æµ‹è¯•**
- [ ] å¤šç”¨æˆ·åŒæ—¶ç­¾åˆ°çš„å¹¶å‘å¤„ç†
- [ ] é•¿æ—¶é—´è¿ç»­å·¥ä½œçš„å†…å­˜å ç”¨
- [ ] ç½‘ç»œä¸ç¨³å®šç¯å¢ƒä¸‹çš„é‡è¯•æœºåˆ¶

---

## ğŸ“Š æ€»ä½“è¯„ä¼°

**åŠŸèƒ½å®Œæ•´åº¦**: 95% âœ…  
**ä»£ç è´¨é‡**: 85% âš ï¸  
**å®‰å…¨æ€§**: 80% âš ï¸  
**ç”¨æˆ·ä½“éªŒ**: 90% âœ…  
**å¯ç»´æŠ¤æ€§**: 85% âš ï¸

**æ€»ä½“å»ºè®®**: åŠŸèƒ½åŸºæœ¬å®Œå–„ï¼Œä½†éœ€è¦åŠ å¼ºç”¨æˆ·IDéªŒè¯å’Œé”™è¯¯å¤„ç†çš„å¥å£®æ€§ã€‚å»ºè®®ä¼˜å…ˆä¿®å¤P0çº§åˆ«é—®é¢˜åè¿›è¡Œç”¨æˆ·æµ‹è¯•ã€‚

---

## ğŸ”§ å…·ä½“ä¿®å¤ä»£ç å»ºè®®

### 1. ç”¨æˆ·IDéªŒè¯åŠ å¼º
```typescript
// åœ¨handleCheckInå’ŒhandleCheckOutå¼€å§‹æ—¶æ·»åŠ 
const validateUserId = (volunteerId: string, volunteer: any): number | null => {
  const userId = volunteer?.userId;
  
  if (!userId || typeof userId !== 'number' || userId <= 0) {
    console.error('ç”¨æˆ·IDéªŒè¯å¤±è´¥:', { 
      volunteerId, 
      userId, 
      volunteerData: volunteer 
    });
    return null;
  }
  
  return userId;
};
```

### 2. é‡å¤ç‚¹å‡»é˜²æŠ¤
```typescript
// åœ¨ç»„ä»¶çŠ¶æ€ä¸­æ·»åŠ 
const [operationInProgress, setOperationInProgress] = useState<Record<string, boolean>>({});

// åœ¨æ“ä½œå¼€å§‹æ—¶æ£€æŸ¥
if (operationInProgress[volunteerId]) {
  console.log('æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
  return;
}
setOperationInProgress(prev => ({ ...prev, [volunteerId]: true }));
```

### 3. è®¤è¯å¤±æ•ˆå¤„ç†
```typescript
// åœ¨APIé”™è¯¯å¤„ç†ä¸­æ·»åŠ 
if (error.message.includes('401') || error.message.includes('403')) {
  Alert.alert(
    'ç™»å½•å·²è¿‡æœŸ',
    'è¯·é‡æ–°ç™»å½•ä»¥ç»§ç»­æ“ä½œ',
    [
      { text: 'å–æ¶ˆ', style: 'cancel' },
      { 
        text: 'é‡æ–°ç™»å½•', 
        onPress: () => navigation.navigate('Login')
      }
    ]
  );
  await logout(); // æ¸…é™¤æœ¬åœ°è®¤è¯ä¿¡æ¯
  return;
}
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-08-25  
**å®¡è®¡å·¥å…·**: Claude Codeé™æ€åˆ†æ  
**å»ºè®®å¤å®¡æ—¶é—´**: ä¿®å¤å®Œæˆå1å‘¨å†…