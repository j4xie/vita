<!DOCTYPE html>
<html>
<head>
    <title>QR Code Decoder</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial; margin: 20px; }
        canvas { border: 1px solid #ccc; margin: 10px 0; }
        .result { padding: 15px; background: #f8f9fa; border-radius: 8px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h2>QR Code Decoder</h2>
    <input type="file" id="fileInput" accept="image/*" />
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="result" class="result">请选择QR码图片文件...</div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        const fileInput = document.getElementById('fileInput');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const result = document.getElementById('result');

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    // 设置canvas尺寸
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // 绘制图像
                    ctx.drawImage(img, 0, 0);
                    
                    // 获取图像数据
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // 解析QR码
                    const qrCode = jsQR(imageData.data, canvas.width, canvas.height);
                    
                    if (qrCode) {
                        console.log('QR码解析成功:', qrCode.data);
                        result.className = 'result success';
                        result.innerHTML = `
                            <strong>✅ QR码解析成功!</strong><br><br>
                            <strong>内容:</strong> ${qrCode.data}<br><br>
                            <strong>长度:</strong> ${qrCode.data.length}<br><br>
                            <strong>格式分析:</strong><br>
                            ${analyzeQRFormat(qrCode.data)}
                        `;
                    } else {
                        result.className = 'result error';
                        result.innerHTML = '❌ 无法识别QR码，请确保图片清晰且包含有效的QR码';
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        function analyzeQRFormat(data) {
            let analysis = '';
            
            if (data.startsWith('VG_USER_')) {
                analysis += '• 类型: PomeloX用户身份码<br>';
                analysis += '• 格式: 标准VG_USER_格式 ✅<br>';
            } else if (data.startsWith('VG_ACTIVITY_')) {
                analysis += '• 类型: PomeloX活动码<br>';
                analysis += '• 格式: 标准VG_ACTIVITY_格式 ✅<br>';
            } else if (data.startsWith('VG_REF_')) {
                analysis += '• 类型: PomeloX推荐码<br>';
                analysis += '• 格式: 标准VG_REF_格式 ✅<br>';
            } else if (/^[A-Z0-9]{8}$/.test(data)) {
                analysis += '• 类型: 推荐码<br>';
                analysis += '• 格式: 8位直接格式 ✅<br>';
            } else if (/^\d+$/.test(data)) {
                analysis += '• 类型: 数字ID (可能是活动ID)<br>';
                analysis += '• 格式: 纯数字格式 ⚠️<br>';
            } else if (/^[a-f0-9]{32}$/.test(data)) {
                analysis += '• 类型: MD5哈希<br>';
                analysis += '• 格式: 32位十六进制 ❌<br>';
                analysis += '• 说明: 当前不支持此格式的活动码<br>';
            } else if (data.startsWith('http')) {
                analysis += '• 类型: 网址链接<br>';
                analysis += '• 格式: URL格式<br>';
            } else {
                analysis += '• 类型: 未知格式<br>';
                analysis += '• 格式: 无法识别 ❌<br>';
            }
            
            return analysis;
        }
    </script>
</body>
</html>