<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PomeloX Webç«¯é—®é¢˜éªŒè¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f9f9f9;
        }
        .test-result {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
        }
        .modal-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” PomeloX Webç«¯é—®é¢˜éªŒè¯</h1>
    
    <!-- é—®é¢˜ä¸€ï¼šæ—¶é—´åˆ†ç±»éªŒè¯ -->
    <div class="test-section">
        <h2>ğŸ“… é—®é¢˜ä¸€ï¼šæ´»åŠ¨æ—¶é—´åˆ†ç±»é€»è¾‘éªŒè¯</h2>
        <p>éªŒè¯æ´»åŠ¨æ—¶é—´æ•°æ®æ ¼å¼å’Œåˆ†ç±»é€»è¾‘</p>
        <button onclick="testTimeClassification()">å¼€å§‹éªŒè¯æ—¶é—´åˆ†ç±»</button>
        <div id="timeTestResult" class="test-result"></div>
    </div>

    <!-- é—®é¢˜äºŒï¼šæ‘„åƒå¤´æƒé™éªŒè¯ -->
    <div class="test-section">
        <h2>ğŸ“· é—®é¢˜äºŒï¼šæ‘„åƒå¤´æƒé™éªŒè¯</h2>
        <p>éªŒè¯æ‘„åƒå¤´è®¿é—®æƒé™å’Œç›¸å…³API</p>
        <button onclick="testCameraPermission()">æµ‹è¯•æ‘„åƒå¤´æƒé™</button>
        <button onclick="startCamera()">å¯åŠ¨æ‘„åƒå¤´</button>
        <button onclick="stopCamera()">åœæ­¢æ‘„åƒå¤´</button>
        <div id="cameraTestResult" class="test-result"></div>
        <video id="testVideo" width="300" height="200" style="border: 1px solid #ddd; margin: 10px 0;"></video>
    </div>

    <!-- é—®é¢˜ä¸‰ï¼šæ¨èç è¾“å…¥éªŒè¯ -->
    <div class="test-section">
        <h2>ğŸ« é—®é¢˜ä¸‰ï¼šæ¨èç è¾“å…¥åŠŸèƒ½éªŒè¯</h2>
        <p>éªŒè¯Alert.promptå’Œè‡ªå®šä¹‰Modalçš„æ”¯æŒæƒ…å†µ</p>
        <button onclick="testAlertPrompt()">æµ‹è¯•Alert.prompt</button>
        <button onclick="testCustomModal()">æµ‹è¯•è‡ªå®šä¹‰Modal</button>
        <div id="referralTestResult" class="test-result"></div>
    </div>

    <!-- è‡ªå®šä¹‰Modal -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <h3>è¾“å…¥æ¨èç </h3>
            <input type="text" id="referralInput" class="modal-input" placeholder="è¯·è¾“å…¥æ¨èç ">
            <div>
                <button onclick="submitReferralCode()">ç¡®è®¤</button>
                <button onclick="closeCustomModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        let currentStream = null;
        
        // å·¥å…·å‡½æ•°ï¼šè¾“å‡ºç»“æœ
        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        // é—®é¢˜ä¸€ï¼šæ—¶é—´åˆ†ç±»éªŒè¯
        function testTimeClassification() {
            const resultId = 'timeTestResult';
            document.getElementById(resultId).innerHTML = '';
            
            logResult(resultId, '=== å¼€å§‹éªŒè¯æ´»åŠ¨æ—¶é—´åˆ†ç±»é€»è¾‘ ===', 'info');
            
            // 1. ç¯å¢ƒæ£€æŸ¥
            logResult(resultId, `1. å½“å‰æ—¶é—´: ${new Date().toISOString()}`, 'info');
            logResult(resultId, `   æµè§ˆå™¨: ${navigator.userAgent.includes('Safari') ? 'Safari' : 'Chrome/Other'}`, 'info');
            
            // 2. æ¨¡æ‹Ÿæ´»åŠ¨æ•°æ®è¿›è¡Œæµ‹è¯•
            const mockActivities = [
                {
                    id: 1,
                    name: "å·²ç»“æŸæ´»åŠ¨",
                    startTime: "2024-01-15 14:00:00",
                    endTime: "2024-01-15 16:00:00",
                    signStatus: undefined
                },
                {
                    id: 2,
                    name: "è¿›è¡Œä¸­æ´»åŠ¨",
                    startTime: new Date(Date.now() - 3600000).toISOString().replace('T', ' ').slice(0, 19),
                    endTime: new Date(Date.now() + 3600000).toISOString().replace('T', ' ').slice(0, 19),
                    signStatus: undefined
                },
                {
                    id: 3,
                    name: "å³å°†å¼€å§‹æ´»åŠ¨",
                    startTime: new Date(Date.now() + 3600000).toISOString().replace('T', ' ').slice(0, 19),
                    endTime: new Date(Date.now() + 7200000).toISOString().replace('T', ' ').slice(0, 19),
                    signStatus: undefined
                },
                {
                    id: 4,
                    name: "å·²æŠ¥åæ´»åŠ¨",
                    startTime: new Date(Date.now() + 3600000).toISOString().replace('T', ' ').slice(0, 19),
                    endTime: new Date(Date.now() + 7200000).toISOString().replace('T', ' ').slice(0, 19),
                    signStatus: -1
                }
            ];
            
            logResult(resultId, '2. æµ‹è¯•æ—¶é—´è§£æå…¼å®¹æ€§:', 'info');
            
            mockActivities.forEach(activity => {
                try {
                    // æµ‹è¯•åŸæ ¼å¼è§£æ
                    const date1 = new Date(activity.startTime);
                    const isValid1 = !isNaN(date1.getTime());
                    
                    // æµ‹è¯•ISOæ ¼å¼è§£æ
                    const date2 = new Date(activity.startTime.replace(' ', 'T'));
                    const isValid2 = !isNaN(date2.getTime());
                    
                    logResult(resultId, `   æ´»åŠ¨${activity.id}: åŸæ ¼å¼${isValid1 ? 'âœ…' : 'âŒ'} ISOæ ¼å¼${isValid2 ? 'âœ…' : 'âŒ'}`, isValid2 ? 'success' : 'error');
                    
                    if (isValid2) {
                        // è®¡ç®—çŠ¶æ€
                        const now = new Date();
                        const start = new Date(activity.startTime.replace(' ', 'T'));
                        const end = new Date(activity.endTime.replace(' ', 'T'));
                        
                        let status;
                        if (activity.signStatus === -1) status = 'registered';
                        else if (activity.signStatus === 1) status = 'checked_in';
                        else if (end < now) status = 'ended';
                        else if (start <= now && end >= now) status = 'ongoing';
                        else status = 'upcoming';
                        
                        logResult(resultId, `   çŠ¶æ€è®¡ç®—: ${status}`, 'success');
                    }
                } catch (error) {
                    logResult(resultId, `   æ´»åŠ¨${activity.id}è§£æå¤±è´¥: ${error.message}`, 'error');
                }
            });
            
            // 3. æµ‹è¯•åˆ†ç±»é€»è¾‘
            logResult(resultId, '3. åˆ†ç±»é€»è¾‘æµ‹è¯•å®Œæˆ', 'success');
        }

        // é—®é¢˜äºŒï¼šæ‘„åƒå¤´æƒé™éªŒè¯
        function testCameraPermission() {
            const resultId = 'cameraTestResult';
            document.getElementById(resultId).innerHTML = '';
            
            logResult(resultId, '=== å¼€å§‹éªŒè¯æ‘„åƒå¤´æƒé™ ===', 'info');
            
            // 1. ç¯å¢ƒæ£€æŸ¥
            logResult(resultId, '1. ç¯å¢ƒæ£€æŸ¥:', 'info');
            logResult(resultId, `   åè®®: ${location.protocol}`, location.protocol === 'https:' ? 'success' : 'error');
            logResult(resultId, `   åŸŸå: ${location.hostname}`, 'info');
            logResult(resultId, `   MediaDevicesæ”¯æŒ: ${!!navigator.mediaDevices ? 'âœ…' : 'âŒ'}`, !!navigator.mediaDevices ? 'success' : 'error');
            logResult(resultId, `   getUserMediaæ”¯æŒ: ${!!navigator.mediaDevices?.getUserMedia ? 'âœ…' : 'âŒ'}`, !!navigator.mediaDevices?.getUserMedia ? 'success' : 'error');
            
            // 2. æƒé™æŸ¥è¯¢
            if (navigator.permissions) {
                navigator.permissions.query({name: 'camera'})
                    .then(result => {
                        logResult(resultId, `   æ‘„åƒå¤´æƒé™çŠ¶æ€: ${result.state}`, result.state === 'granted' ? 'success' : 'warning');
                    })
                    .catch(error => {
                        logResult(resultId, `   æƒé™æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
                    });
            } else {
                logResult(resultId, '   æƒé™APIä¸æ”¯æŒ', 'warning');
            }
            
            // 3. è®¾å¤‡æšä¸¾
            if (navigator.mediaDevices?.enumerateDevices) {
                navigator.mediaDevices.enumerateDevices()
                    .then(devices => {
                        const cameras = devices.filter(device => device.kind === 'videoinput');
                        logResult(resultId, `   æ£€æµ‹åˆ°æ‘„åƒå¤´æ•°é‡: ${cameras.length}`, cameras.length > 0 ? 'success' : 'warning');
                        cameras.forEach((camera, index) => {
                            logResult(resultId, `   æ‘„åƒå¤´${index + 1}: ${camera.label || 'æœªçŸ¥è®¾å¤‡'}`, 'info');
                        });
                    })
                    .catch(error => {
                        logResult(resultId, `   è®¾å¤‡æšä¸¾å¤±è´¥: ${error.message}`, 'error');
                    });
            }
        }

        function startCamera() {
            const resultId = 'cameraTestResult';
            const video = document.getElementById('testVideo');
            
            logResult(resultId, '4. å°è¯•å¯åŠ¨æ‘„åƒå¤´...', 'info');
            
            if (!navigator.mediaDevices?.getUserMedia) {
                logResult(resultId, '   getUserMediaä¸æ”¯æŒ', 'error');
                return;
            }
            
            const constraints = {
                video: {
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    currentStream = stream;
                    video.srcObject = stream;
                    video.play();
                    logResult(resultId, '   æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ âœ…', 'success');
                    logResult(resultId, `   è§†é¢‘è½¨é“æ•°: ${stream.getVideoTracks().length}`, 'success');
                })
                .catch(error => {
                    logResult(resultId, `   æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ${error.name} - ${error.message}`, 'error');
                    
                    // æä¾›å…·ä½“çš„é”™è¯¯æŒ‡å¯¼
                    switch(error.name) {
                        case 'NotAllowedError':
                            logResult(resultId, '   è§£å†³æ–¹æ¡ˆ: ç‚¹å‡»åœ°å€æ çš„ğŸ”’å›¾æ ‡ï¼Œå…è®¸æ‘„åƒå¤´è®¿é—®', 'warning');
                            break;
                        case 'NotFoundError':
                            logResult(resultId, '   è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥è®¾å¤‡æ˜¯å¦è¿æ¥æ‘„åƒå¤´', 'warning');
                            break;
                        case 'OverconstrainedError':
                            logResult(resultId, '   è§£å†³æ–¹æ¡ˆ: å°è¯•å®½æ¾çš„çº¦æŸæ¡ä»¶', 'warning');
                            break;
                        default:
                            logResult(resultId, '   è§£å†³æ–¹æ¡ˆ: æ£€æŸ¥æµè§ˆå™¨è®¾ç½®å’Œè®¾å¤‡æƒé™', 'warning');
                    }
                });
        }

        function stopCamera() {
            const resultId = 'cameraTestResult';
            const video = document.getElementById('testVideo');
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                currentStream = null;
                logResult(resultId, '   æ‘„åƒå¤´å·²åœæ­¢', 'info');
            } else {
                logResult(resultId, '   æ²¡æœ‰æ´»è·ƒçš„æ‘„åƒå¤´æµ', 'warning');
            }
        }

        // é—®é¢˜ä¸‰ï¼šæ¨èç è¾“å…¥éªŒè¯
        function testAlertPrompt() {
            const resultId = 'referralTestResult';
            document.getElementById(resultId).innerHTML = '';
            
            logResult(resultId, '=== å¼€å§‹éªŒè¯æ¨èç è¾“å…¥åŠŸèƒ½ ===', 'info');
            
            // 1. Alert.promptæ”¯æŒæ£€æŸ¥
            logResult(resultId, '1. Alert.promptæ”¯æŒæ€§æ£€æŸ¥:', 'info');
            logResult(resultId, `   Alertå¯¹è±¡å­˜åœ¨: ${typeof window.Alert !== 'undefined' ? 'âœ…' : 'âŒ'}`, typeof window.Alert !== 'undefined' ? 'success' : 'error');
            logResult(resultId, `   Alert.promptæ–¹æ³•: ${typeof window.Alert?.prompt !== 'undefined' ? 'âœ…' : 'âŒ'}`, typeof window.Alert?.prompt !== 'undefined' ? 'success' : 'error');
            logResult(resultId, `   åŸç”Ÿprompt: ${typeof window.prompt !== 'undefined' ? 'âœ…' : 'âŒ'}`, typeof window.prompt !== 'undefined' ? 'success' : 'error');
            
            // 2. å°è¯•Alert.prompt
            if (typeof window.Alert?.prompt !== 'undefined') {
                try {
                    window.Alert.prompt(
                        'æµ‹è¯•æ¨èç è¾“å…¥',
                        'è¯·è¾“å…¥æµ‹è¯•æ¨èç ',
                        [
                            { text: 'å–æ¶ˆ', style: 'cancel' },
                            { text: 'ç¡®è®¤', onPress: (text) => {
                                logResult(resultId, `   Alert.promptæˆåŠŸï¼Œè¾“å…¥: ${text || 'ç©º'}`, 'success');
                            }}
                        ],
                        'plain-text'
                    );
                } catch (error) {
                    logResult(resultId, `   Alert.promptå¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                logResult(resultId, '   Alert.promptä¸å¯ç”¨ï¼Œè¿™æ˜¯Webç«¯çš„é¢„æœŸæƒ…å†µ', 'warning');
            }
            
            // 3. åŸç”Ÿpromptæµ‹è¯•
            if (typeof window.prompt !== 'undefined') {
                setTimeout(() => {
                    try {
                        const result = window.prompt('æµ‹è¯•åŸç”Ÿprompt', 'è¯·è¾“å…¥æ¨èç ');
                        logResult(resultId, `   åŸç”Ÿpromptç»“æœ: ${result || 'å–æ¶ˆ/ç©º'}`, 'info');
                    } catch (error) {
                        logResult(resultId, `   åŸç”Ÿpromptå¤±è´¥: ${error.message}`, 'error');
                    }
                }, 100);
            }
        }

        function testCustomModal() {
            const resultId = 'referralTestResult';
            logResult(resultId, '2. æµ‹è¯•è‡ªå®šä¹‰Modal:', 'info');
            
            const modal = document.getElementById('customModal');
            modal.style.display = 'flex';
            logResult(resultId, '   è‡ªå®šä¹‰Modalæ˜¾ç¤ºæˆåŠŸ âœ…', 'success');
        }

        function closeCustomModal() {
            const modal = document.getElementById('customModal');
            modal.style.display = 'none';
        }

        function submitReferralCode() {
            const input = document.getElementById('referralInput');
            const code = input.value.trim();
            const resultId = 'referralTestResult';
            
            if (code) {
                logResult(resultId, `   ç”¨æˆ·è¾“å…¥æ¨èç : ${code}`, 'success');
                logResult(resultId, `   éªŒè¯æ ¼å¼: ${/^[A-Z0-9]{8}$/.test(code) ? 'âœ… æœ‰æ•ˆ' : 'âŒ æ— æ•ˆ'}`, /^[A-Z0-9]{8}$/.test(code) ? 'success' : 'warning');
            } else {
                logResult(resultId, '   ç”¨æˆ·å–æ¶ˆè¾“å…¥', 'info');
            }
            
            closeCustomModal();
            input.value = '';
        }

        // é¡µé¢åŠ è½½æ—¶çš„è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            console.log('ğŸ” PomeloX Webç«¯é—®é¢˜éªŒè¯é¡µé¢å·²åŠ è½½');
            console.log('è¯·ç‚¹å‡»ç›¸åº”æŒ‰é’®è¿›è¡Œé—®é¢˜éªŒè¯');
        });
    </script>
</body>
</html>





