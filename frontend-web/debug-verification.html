<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PomeloX Web端问题验证</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f9f9f9;
        }
        .test-result {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
        }
        .modal-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>🔍 PomeloX Web端问题验证</h1>
    
    <!-- 问题一：时间分类验证 -->
    <div class="test-section">
        <h2>📅 问题一：活动时间分类逻辑验证</h2>
        <p>验证活动时间数据格式和分类逻辑</p>
        <button onclick="testTimeClassification()">开始验证时间分类</button>
        <div id="timeTestResult" class="test-result"></div>
    </div>

    <!-- 问题二：摄像头权限验证 -->
    <div class="test-section">
        <h2>📷 问题二：摄像头权限验证</h2>
        <p>验证摄像头访问权限和相关API</p>
        <button onclick="testCameraPermission()">测试摄像头权限</button>
        <button onclick="startCamera()">启动摄像头</button>
        <button onclick="stopCamera()">停止摄像头</button>
        <div id="cameraTestResult" class="test-result"></div>
        <video id="testVideo" width="300" height="200" style="border: 1px solid #ddd; margin: 10px 0;"></video>
    </div>

    <!-- 问题三：推荐码输入验证 -->
    <div class="test-section">
        <h2>🎫 问题三：推荐码输入功能验证</h2>
        <p>验证Alert.prompt和自定义Modal的支持情况</p>
        <button onclick="testAlertPrompt()">测试Alert.prompt</button>
        <button onclick="testCustomModal()">测试自定义Modal</button>
        <div id="referralTestResult" class="test-result"></div>
    </div>

    <!-- 自定义Modal -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <h3>输入推荐码</h3>
            <input type="text" id="referralInput" class="modal-input" placeholder="请输入推荐码">
            <div>
                <button onclick="submitReferralCode()">确认</button>
                <button onclick="closeCustomModal()">取消</button>
            </div>
        </div>
    </div>

    <script>
        let currentStream = null;
        
        // 工具函数：输出结果
        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        // 问题一：时间分类验证
        function testTimeClassification() {
            const resultId = 'timeTestResult';
            document.getElementById(resultId).innerHTML = '';
            
            logResult(resultId, '=== 开始验证活动时间分类逻辑 ===', 'info');
            
            // 1. 环境检查
            logResult(resultId, `1. 当前时间: ${new Date().toISOString()}`, 'info');
            logResult(resultId, `   浏览器: ${navigator.userAgent.includes('Safari') ? 'Safari' : 'Chrome/Other'}`, 'info');
            
            // 2. 模拟活动数据进行测试
            const mockActivities = [
                {
                    id: 1,
                    name: "已结束活动",
                    startTime: "2024-01-15 14:00:00",
                    endTime: "2024-01-15 16:00:00",
                    signStatus: undefined
                },
                {
                    id: 2,
                    name: "进行中活动",
                    startTime: new Date(Date.now() - 3600000).toISOString().replace('T', ' ').slice(0, 19),
                    endTime: new Date(Date.now() + 3600000).toISOString().replace('T', ' ').slice(0, 19),
                    signStatus: undefined
                },
                {
                    id: 3,
                    name: "即将开始活动",
                    startTime: new Date(Date.now() + 3600000).toISOString().replace('T', ' ').slice(0, 19),
                    endTime: new Date(Date.now() + 7200000).toISOString().replace('T', ' ').slice(0, 19),
                    signStatus: undefined
                },
                {
                    id: 4,
                    name: "已报名活动",
                    startTime: new Date(Date.now() + 3600000).toISOString().replace('T', ' ').slice(0, 19),
                    endTime: new Date(Date.now() + 7200000).toISOString().replace('T', ' ').slice(0, 19),
                    signStatus: -1
                }
            ];
            
            logResult(resultId, '2. 测试时间解析兼容性:', 'info');
            
            mockActivities.forEach(activity => {
                try {
                    // 测试原格式解析
                    const date1 = new Date(activity.startTime);
                    const isValid1 = !isNaN(date1.getTime());
                    
                    // 测试ISO格式解析
                    const date2 = new Date(activity.startTime.replace(' ', 'T'));
                    const isValid2 = !isNaN(date2.getTime());
                    
                    logResult(resultId, `   活动${activity.id}: 原格式${isValid1 ? '✅' : '❌'} ISO格式${isValid2 ? '✅' : '❌'}`, isValid2 ? 'success' : 'error');
                    
                    if (isValid2) {
                        // 计算状态
                        const now = new Date();
                        const start = new Date(activity.startTime.replace(' ', 'T'));
                        const end = new Date(activity.endTime.replace(' ', 'T'));
                        
                        let status;
                        if (activity.signStatus === -1) status = 'registered';
                        else if (activity.signStatus === 1) status = 'checked_in';
                        else if (end < now) status = 'ended';
                        else if (start <= now && end >= now) status = 'ongoing';
                        else status = 'upcoming';
                        
                        logResult(resultId, `   状态计算: ${status}`, 'success');
                    }
                } catch (error) {
                    logResult(resultId, `   活动${activity.id}解析失败: ${error.message}`, 'error');
                }
            });
            
            // 3. 测试分类逻辑
            logResult(resultId, '3. 分类逻辑测试完成', 'success');
        }

        // 问题二：摄像头权限验证
        function testCameraPermission() {
            const resultId = 'cameraTestResult';
            document.getElementById(resultId).innerHTML = '';
            
            logResult(resultId, '=== 开始验证摄像头权限 ===', 'info');
            
            // 1. 环境检查
            logResult(resultId, '1. 环境检查:', 'info');
            logResult(resultId, `   协议: ${location.protocol}`, location.protocol === 'https:' ? 'success' : 'error');
            logResult(resultId, `   域名: ${location.hostname}`, 'info');
            logResult(resultId, `   MediaDevices支持: ${!!navigator.mediaDevices ? '✅' : '❌'}`, !!navigator.mediaDevices ? 'success' : 'error');
            logResult(resultId, `   getUserMedia支持: ${!!navigator.mediaDevices?.getUserMedia ? '✅' : '❌'}`, !!navigator.mediaDevices?.getUserMedia ? 'success' : 'error');
            
            // 2. 权限查询
            if (navigator.permissions) {
                navigator.permissions.query({name: 'camera'})
                    .then(result => {
                        logResult(resultId, `   摄像头权限状态: ${result.state}`, result.state === 'granted' ? 'success' : 'warning');
                    })
                    .catch(error => {
                        logResult(resultId, `   权限查询失败: ${error.message}`, 'error');
                    });
            } else {
                logResult(resultId, '   权限API不支持', 'warning');
            }
            
            // 3. 设备枚举
            if (navigator.mediaDevices?.enumerateDevices) {
                navigator.mediaDevices.enumerateDevices()
                    .then(devices => {
                        const cameras = devices.filter(device => device.kind === 'videoinput');
                        logResult(resultId, `   检测到摄像头数量: ${cameras.length}`, cameras.length > 0 ? 'success' : 'warning');
                        cameras.forEach((camera, index) => {
                            logResult(resultId, `   摄像头${index + 1}: ${camera.label || '未知设备'}`, 'info');
                        });
                    })
                    .catch(error => {
                        logResult(resultId, `   设备枚举失败: ${error.message}`, 'error');
                    });
            }
        }

        function startCamera() {
            const resultId = 'cameraTestResult';
            const video = document.getElementById('testVideo');
            
            logResult(resultId, '4. 尝试启动摄像头...', 'info');
            
            if (!navigator.mediaDevices?.getUserMedia) {
                logResult(resultId, '   getUserMedia不支持', 'error');
                return;
            }
            
            const constraints = {
                video: {
                    facingMode: { ideal: 'environment' },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    currentStream = stream;
                    video.srcObject = stream;
                    video.play();
                    logResult(resultId, '   摄像头启动成功 ✅', 'success');
                    logResult(resultId, `   视频轨道数: ${stream.getVideoTracks().length}`, 'success');
                })
                .catch(error => {
                    logResult(resultId, `   摄像头启动失败: ${error.name} - ${error.message}`, 'error');
                    
                    // 提供具体的错误指导
                    switch(error.name) {
                        case 'NotAllowedError':
                            logResult(resultId, '   解决方案: 点击地址栏的🔒图标，允许摄像头访问', 'warning');
                            break;
                        case 'NotFoundError':
                            logResult(resultId, '   解决方案: 检查设备是否连接摄像头', 'warning');
                            break;
                        case 'OverconstrainedError':
                            logResult(resultId, '   解决方案: 尝试宽松的约束条件', 'warning');
                            break;
                        default:
                            logResult(resultId, '   解决方案: 检查浏览器设置和设备权限', 'warning');
                    }
                });
        }

        function stopCamera() {
            const resultId = 'cameraTestResult';
            const video = document.getElementById('testVideo');
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                currentStream = null;
                logResult(resultId, '   摄像头已停止', 'info');
            } else {
                logResult(resultId, '   没有活跃的摄像头流', 'warning');
            }
        }

        // 问题三：推荐码输入验证
        function testAlertPrompt() {
            const resultId = 'referralTestResult';
            document.getElementById(resultId).innerHTML = '';
            
            logResult(resultId, '=== 开始验证推荐码输入功能 ===', 'info');
            
            // 1. Alert.prompt支持检查
            logResult(resultId, '1. Alert.prompt支持性检查:', 'info');
            logResult(resultId, `   Alert对象存在: ${typeof window.Alert !== 'undefined' ? '✅' : '❌'}`, typeof window.Alert !== 'undefined' ? 'success' : 'error');
            logResult(resultId, `   Alert.prompt方法: ${typeof window.Alert?.prompt !== 'undefined' ? '✅' : '❌'}`, typeof window.Alert?.prompt !== 'undefined' ? 'success' : 'error');
            logResult(resultId, `   原生prompt: ${typeof window.prompt !== 'undefined' ? '✅' : '❌'}`, typeof window.prompt !== 'undefined' ? 'success' : 'error');
            
            // 2. 尝试Alert.prompt
            if (typeof window.Alert?.prompt !== 'undefined') {
                try {
                    window.Alert.prompt(
                        '测试推荐码输入',
                        '请输入测试推荐码',
                        [
                            { text: '取消', style: 'cancel' },
                            { text: '确认', onPress: (text) => {
                                logResult(resultId, `   Alert.prompt成功，输入: ${text || '空'}`, 'success');
                            }}
                        ],
                        'plain-text'
                    );
                } catch (error) {
                    logResult(resultId, `   Alert.prompt失败: ${error.message}`, 'error');
                }
            } else {
                logResult(resultId, '   Alert.prompt不可用，这是Web端的预期情况', 'warning');
            }
            
            // 3. 原生prompt测试
            if (typeof window.prompt !== 'undefined') {
                setTimeout(() => {
                    try {
                        const result = window.prompt('测试原生prompt', '请输入推荐码');
                        logResult(resultId, `   原生prompt结果: ${result || '取消/空'}`, 'info');
                    } catch (error) {
                        logResult(resultId, `   原生prompt失败: ${error.message}`, 'error');
                    }
                }, 100);
            }
        }

        function testCustomModal() {
            const resultId = 'referralTestResult';
            logResult(resultId, '2. 测试自定义Modal:', 'info');
            
            const modal = document.getElementById('customModal');
            modal.style.display = 'flex';
            logResult(resultId, '   自定义Modal显示成功 ✅', 'success');
        }

        function closeCustomModal() {
            const modal = document.getElementById('customModal');
            modal.style.display = 'none';
        }

        function submitReferralCode() {
            const input = document.getElementById('referralInput');
            const code = input.value.trim();
            const resultId = 'referralTestResult';
            
            if (code) {
                logResult(resultId, `   用户输入推荐码: ${code}`, 'success');
                logResult(resultId, `   验证格式: ${/^[A-Z0-9]{8}$/.test(code) ? '✅ 有效' : '❌ 无效'}`, /^[A-Z0-9]{8}$/.test(code) ? 'success' : 'warning');
            } else {
                logResult(resultId, '   用户取消输入', 'info');
            }
            
            closeCustomModal();
            input.value = '';
        }

        // 页面加载时的自动检查
        window.addEventListener('load', () => {
            console.log('🔍 PomeloX Web端问题验证页面已加载');
            console.log('请点击相应按钮进行问题验证');
        });
    </script>
</body>
</html>





