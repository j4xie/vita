<!DOCTYPE html>
<html>
<head>
    <title>简单活动测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .step { border: 1px solid #ddd; padding: 15px; margin: 10px 0; background: #f9f9f9; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
        input { padding: 8px; width: 500px; margin: 5px; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; cursor: pointer; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #cce7ff; color: #004085; }
    </style>
</head>
<body>
    <h1>🔍 活动报名签到问题检测</h1>
    
    <div class="step">
        <h3>第1步：设置Token</h3>
        <p>在App或Web端按F12，找到Network → 任意API请求 → Headers → Authorization中的Bearer token</p>
        <input type="text" id="token" placeholder="粘贴你的Bearer Token（很长的字符串）">
        <button onclick="setToken()">设置Token</button>
        <div id="tokenResult" class="result"></div>
    </div>

    <div class="step">
        <h3>第2步：一键检测</h3>
        <button onclick="quickCheck()" style="font-size: 16px; padding: 15px 30px;">🚀 开始检测</button>
        <div id="checkResult" class="result"></div>
    </div>

    <script>
        let token = '';
        const API_BASE = 'https://www.vitaglobal.icu';

        function setToken() {
            token = document.getElementById('token').value.trim();
            const result = document.getElementById('tokenResult');
            
            if (token) {
                result.className = 'result success';
                result.textContent = '✅ Token已设置，长度: ' + token.length + ' 字符';
            } else {
                result.className = 'result error';
                result.textContent = '❌ 请输入有效的Token';
            }
        }

        async function apiCall(endpoint, params = {}) {
            if (!token) {
                return { error: 'Token未设置' };
            }

            const url = new URL(endpoint, API_BASE);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                return { success: true, data };
            } catch (error) {
                return { error: error.message };
            }
        }

        async function quickCheck() {
            const result = document.getElementById('checkResult');
            result.className = 'result info';
            result.textContent = '正在检测...\n';

            let report = '=== 检测报告 ===\n\n';

            // 1. 检查用户信息
            report += '1️⃣ 检查用户信息...\n';
            const userInfo = await apiCall('/app/user/info');
            
            if (userInfo.error) {
                report += `❌ 获取用户信息失败: ${userInfo.error}\n`;
                report += '可能原因：Token无效或已过期\n\n';
                result.textContent = report;
                result.className = 'result error';
                return;
            }

            const userId = userInfo.data?.data?.userId;
            const userName = userInfo.data?.data?.userName;
            
            if (userId) {
                report += `✅ 用户ID: ${userId}\n`;
                report += `✅ 用户名: ${userName}\n\n`;
            } else {
                report += '❌ 无法获取用户ID\n\n';
                result.textContent = report;
                result.className = 'result error';
                return;
            }

            // 2. 检查已报名活动
            report += '2️⃣ 检查已报名活动...\n';
            const userActivities = await apiCall('/app/activity/userActivitylist', { userId });
            
            if (userActivities.error) {
                report += `❌ 获取报名活动失败: ${userActivities.error}\n\n`;
            } else {
                const activities = userActivities.data?.data || [];
                report += `✅ 已报名活动数量: ${activities.length}\n`;
                
                const uciActivities = activities.filter(a => 
                    a.activityName && a.activityName.includes('UCI')
                );
                
                if (uciActivities.length > 0) {
                    report += `✅ 找到UCI活动: ${uciActivities.length}个\n`;
                    uciActivities.forEach(activity => {
                        report += `   - ${activity.activityName} (ID: ${activity.activityId})\n`;
                        report += `     签到状态: ${activity.signStatus === 1 ? '已签到' : '未签到'}\n`;
                    });
                    report += '\n';
                } else {
                    report += '❌ 没有找到已报名的UCI活动！\n';
                    report += '问题确认：用户确实没有报名UCI活动\n\n';
                }
            }

            // 3. 检查所有活动列表
            report += '3️⃣ 检查所有活动列表...\n';
            const allActivities = await apiCall('/app/activity/list', { userId, pageNum: 1, pageSize: 20 });
            
            if (allActivities.error) {
                report += `❌ 获取活动列表失败: ${allActivities.error}\n\n`;
            } else {
                const activities = allActivities.data?.data?.rows || [];
                const uciActivities = activities.filter(a => 
                    a.activityName && a.activityName.includes('UCI')
                );
                
                report += `✅ 系统中UCI活动数量: ${uciActivities.length}\n`;
                
                if (uciActivities.length > 0) {
                    report += '可用的UCI活动:\n';
                    uciActivities.forEach(activity => {
                        report += `   - ${activity.activityName} (ID: ${activity.activityId})\n`;
                    });
                    
                    // 4. 测试第一个UCI活动的签到
                    const testActivity = uciActivities[0];
                    report += `\n4️⃣ 测试签到 "${testActivity.activityName}"...\n`;
                    
                    const signInTest = await apiCall('/app/activity/signIn', { 
                        activityId: testActivity.activityId, 
                        userId 
                    });
                    
                    if (signInTest.error) {
                        report += `❌ 签到API调用失败: ${signInTest.error}\n`;
                    } else {
                        report += `✅ 签到API调用成功\n`;
                        report += `响应码: ${signInTest.data?.code}\n`;
                        report += `响应消息: ${signInTest.data?.msg}\n`;
                        
                        if (signInTest.data?.msg?.includes('尚未报名')) {
                            report += '\n🎯 问题确认: 确实显示"尚未报名该活动"\n';
                        }
                    }
                } else {
                    report += '❌ 系统中没有UCI活动\n';
                }
                report += '\n';
            }

            // 5. 结论
            report += '📋 检测结论:\n';
            if (userActivities.success) {
                const enrolledActivities = userActivities.data?.data || [];
                const hasUCI = enrolledActivities.some(a => a.activityName && a.activityName.includes('UCI'));
                
                if (!hasUCI) {
                    report += '❌ 核心问题：用户确实没有报名UCI活动\n';
                    report += '💡 建议：检查报名功能是否正常工作\n';
                    report += '💡 或者需要重新报名UCI活动\n';
                } else {
                    report += '✅ 用户已报名UCI活动，问题可能在其他地方\n';
                }
            }

            result.textContent = report;
            result.className = 'result info';
        }
    </script>
</body>
</html>