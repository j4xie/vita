<!DOCTYPE html>
<html>
<head>
    <title>ç®€å•æ´»åŠ¨æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .step { border: 1px solid #ddd; padding: 15px; margin: 10px 0; background: #f9f9f9; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
        input { padding: 8px; width: 500px; margin: 5px; }
        button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; cursor: pointer; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #cce7ff; color: #004085; }
    </style>
</head>
<body>
    <h1>ğŸ” æ´»åŠ¨æŠ¥åç­¾åˆ°é—®é¢˜æ£€æµ‹</h1>
    
    <div class="step">
        <h3>ç¬¬1æ­¥ï¼šè®¾ç½®Token</h3>
        <p>åœ¨Appæˆ–Webç«¯æŒ‰F12ï¼Œæ‰¾åˆ°Network â†’ ä»»æ„APIè¯·æ±‚ â†’ Headers â†’ Authorizationä¸­çš„Bearer token</p>
        <input type="text" id="token" placeholder="ç²˜è´´ä½ çš„Bearer Tokenï¼ˆå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼‰">
        <button onclick="setToken()">è®¾ç½®Token</button>
        <div id="tokenResult" class="result"></div>
    </div>

    <div class="step">
        <h3>ç¬¬2æ­¥ï¼šä¸€é”®æ£€æµ‹</h3>
        <button onclick="quickCheck()" style="font-size: 16px; padding: 15px 30px;">ğŸš€ å¼€å§‹æ£€æµ‹</button>
        <div id="checkResult" class="result"></div>
    </div>

    <script>
        let token = '';
        const API_BASE = 'https://www.vitaglobal.icu';

        function setToken() {
            token = document.getElementById('token').value.trim();
            const result = document.getElementById('tokenResult');
            
            if (token) {
                result.className = 'result success';
                result.textContent = 'âœ… Tokenå·²è®¾ç½®ï¼Œé•¿åº¦: ' + token.length + ' å­—ç¬¦';
            } else {
                result.className = 'result error';
                result.textContent = 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„Token';
            }
        }

        async function apiCall(endpoint, params = {}) {
            if (!token) {
                return { error: 'Tokenæœªè®¾ç½®' };
            }

            const url = new URL(endpoint, API_BASE);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                return { success: true, data };
            } catch (error) {
                return { error: error.message };
            }
        }

        async function quickCheck() {
            const result = document.getElementById('checkResult');
            result.className = 'result info';
            result.textContent = 'æ­£åœ¨æ£€æµ‹...\n';

            let report = '=== æ£€æµ‹æŠ¥å‘Š ===\n\n';

            // 1. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
            report += '1ï¸âƒ£ æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯...\n';
            const userInfo = await apiCall('/app/user/info');
            
            if (userInfo.error) {
                report += `âŒ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${userInfo.error}\n`;
                report += 'å¯èƒ½åŸå› ï¼šTokenæ— æ•ˆæˆ–å·²è¿‡æœŸ\n\n';
                result.textContent = report;
                result.className = 'result error';
                return;
            }

            const userId = userInfo.data?.data?.userId;
            const userName = userInfo.data?.data?.userName;
            
            if (userId) {
                report += `âœ… ç”¨æˆ·ID: ${userId}\n`;
                report += `âœ… ç”¨æˆ·å: ${userName}\n\n`;
            } else {
                report += 'âŒ æ— æ³•è·å–ç”¨æˆ·ID\n\n';
                result.textContent = report;
                result.className = 'result error';
                return;
            }

            // 2. æ£€æŸ¥å·²æŠ¥åæ´»åŠ¨
            report += '2ï¸âƒ£ æ£€æŸ¥å·²æŠ¥åæ´»åŠ¨...\n';
            const userActivities = await apiCall('/app/activity/userActivitylist', { userId });
            
            if (userActivities.error) {
                report += `âŒ è·å–æŠ¥åæ´»åŠ¨å¤±è´¥: ${userActivities.error}\n\n`;
            } else {
                const activities = userActivities.data?.data || [];
                report += `âœ… å·²æŠ¥åæ´»åŠ¨æ•°é‡: ${activities.length}\n`;
                
                const uciActivities = activities.filter(a => 
                    a.activityName && a.activityName.includes('UCI')
                );
                
                if (uciActivities.length > 0) {
                    report += `âœ… æ‰¾åˆ°UCIæ´»åŠ¨: ${uciActivities.length}ä¸ª\n`;
                    uciActivities.forEach(activity => {
                        report += `   - ${activity.activityName} (ID: ${activity.activityId})\n`;
                        report += `     ç­¾åˆ°çŠ¶æ€: ${activity.signStatus === 1 ? 'å·²ç­¾åˆ°' : 'æœªç­¾åˆ°'}\n`;
                    });
                    report += '\n';
                } else {
                    report += 'âŒ æ²¡æœ‰æ‰¾åˆ°å·²æŠ¥åçš„UCIæ´»åŠ¨ï¼\n';
                    report += 'é—®é¢˜ç¡®è®¤ï¼šç”¨æˆ·ç¡®å®æ²¡æœ‰æŠ¥åUCIæ´»åŠ¨\n\n';
                }
            }

            // 3. æ£€æŸ¥æ‰€æœ‰æ´»åŠ¨åˆ—è¡¨
            report += '3ï¸âƒ£ æ£€æŸ¥æ‰€æœ‰æ´»åŠ¨åˆ—è¡¨...\n';
            const allActivities = await apiCall('/app/activity/list', { userId, pageNum: 1, pageSize: 20 });
            
            if (allActivities.error) {
                report += `âŒ è·å–æ´»åŠ¨åˆ—è¡¨å¤±è´¥: ${allActivities.error}\n\n`;
            } else {
                const activities = allActivities.data?.data?.rows || [];
                const uciActivities = activities.filter(a => 
                    a.activityName && a.activityName.includes('UCI')
                );
                
                report += `âœ… ç³»ç»Ÿä¸­UCIæ´»åŠ¨æ•°é‡: ${uciActivities.length}\n`;
                
                if (uciActivities.length > 0) {
                    report += 'å¯ç”¨çš„UCIæ´»åŠ¨:\n';
                    uciActivities.forEach(activity => {
                        report += `   - ${activity.activityName} (ID: ${activity.activityId})\n`;
                    });
                    
                    // 4. æµ‹è¯•ç¬¬ä¸€ä¸ªUCIæ´»åŠ¨çš„ç­¾åˆ°
                    const testActivity = uciActivities[0];
                    report += `\n4ï¸âƒ£ æµ‹è¯•ç­¾åˆ° "${testActivity.activityName}"...\n`;
                    
                    const signInTest = await apiCall('/app/activity/signIn', { 
                        activityId: testActivity.activityId, 
                        userId 
                    });
                    
                    if (signInTest.error) {
                        report += `âŒ ç­¾åˆ°APIè°ƒç”¨å¤±è´¥: ${signInTest.error}\n`;
                    } else {
                        report += `âœ… ç­¾åˆ°APIè°ƒç”¨æˆåŠŸ\n`;
                        report += `å“åº”ç : ${signInTest.data?.code}\n`;
                        report += `å“åº”æ¶ˆæ¯: ${signInTest.data?.msg}\n`;
                        
                        if (signInTest.data?.msg?.includes('å°šæœªæŠ¥å')) {
                            report += '\nğŸ¯ é—®é¢˜ç¡®è®¤: ç¡®å®æ˜¾ç¤º"å°šæœªæŠ¥åè¯¥æ´»åŠ¨"\n';
                        }
                    }
                } else {
                    report += 'âŒ ç³»ç»Ÿä¸­æ²¡æœ‰UCIæ´»åŠ¨\n';
                }
                report += '\n';
            }

            // 5. ç»“è®º
            report += 'ğŸ“‹ æ£€æµ‹ç»“è®º:\n';
            if (userActivities.success) {
                const enrolledActivities = userActivities.data?.data || [];
                const hasUCI = enrolledActivities.some(a => a.activityName && a.activityName.includes('UCI'));
                
                if (!hasUCI) {
                    report += 'âŒ æ ¸å¿ƒé—®é¢˜ï¼šç”¨æˆ·ç¡®å®æ²¡æœ‰æŠ¥åUCIæ´»åŠ¨\n';
                    report += 'ğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥æŠ¥ååŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ\n';
                    report += 'ğŸ’¡ æˆ–è€…éœ€è¦é‡æ–°æŠ¥åUCIæ´»åŠ¨\n';
                } else {
                    report += 'âœ… ç”¨æˆ·å·²æŠ¥åUCIæ´»åŠ¨ï¼Œé—®é¢˜å¯èƒ½åœ¨å…¶ä»–åœ°æ–¹\n';
                }
            }

            result.textContent = report;
            result.className = 'result info';
        }
    </script>
</body>
</html>