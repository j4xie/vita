# èº«ä»½è¯†åˆ«ç åŠŸèƒ½ - åç«¯æ›´æ–°éœ€æ±‚

## ğŸ“‹ æ•°æ®åº“ç»“æ„æ›´æ–°

### 1. ç”¨æˆ·è¡¨ (users) æ–°å¢å­—æ®µ

åŸºäºç°æœ‰å­—æ®µï¼Œéœ€è¦æ·»åŠ ä»¥ä¸‹å­—æ®µï¼š

```sql
-- ç»„ç»‡ç›¸å…³ï¼ˆå¿…éœ€ï¼‰
ALTER TABLE users ADD COLUMN current_organization_id VARCHAR(50) COMMENT 'å½“å‰æ´»è·ƒçš„å­¦è”ç»„ç»‡ID';

-- èº«ä»½è¯†åˆ«ç›¸å…³ï¼ˆæ¨èï¼‰
ALTER TABLE users ADD COLUMN avatar_url VARCHAR(255) COMMENT 'å¤´åƒå›¾ç‰‡URL';
ALTER TABLE users ADD COLUMN student_id VARCHAR(50) COMMENT 'å­¦å·';
ALTER TABLE users ADD COLUMN status VARCHAR(20) DEFAULT 'active' COMMENT 'ç”¨æˆ·çŠ¶æ€ï¼šactive/inactive/suspended';

-- ç³»ç»Ÿç®¡ç†ç›¸å…³ï¼ˆæ¨èï¼‰
ALTER TABLE users ADD COLUMN email_verified BOOLEAN DEFAULT false COMMENT 'é‚®ç®±éªŒè¯çŠ¶æ€';
ALTER TABLE users ADD COLUMN created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æ³¨å†Œæ—¶é—´';
ALTER TABLE users ADD COLUMN updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æœ€åæ›´æ–°æ—¶é—´';

-- æ·»åŠ ç´¢å¼•
CREATE INDEX idx_users_current_org ON users(current_organization_id);
CREATE INDEX idx_users_status ON users(status);
```

### 2. ç”¨æˆ·-ç»„ç»‡å…³è”è¡¨ (user_organizations) - æ–°å»º

```sql
CREATE TABLE user_organizations (
    id VARCHAR(50) PRIMARY KEY COMMENT 'å…³è”ID',
    user_id VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·ID',
    organization_id VARCHAR(50) NOT NULL COMMENT 'ç»„ç»‡ID',
    role VARCHAR(20) DEFAULT 'member' COMMENT 'è§’è‰²ï¼šmember/admin/super_admin',
    is_primary BOOLEAN DEFAULT false COMMENT 'æ˜¯å¦ä¸ºä¸»è¦ç»„ç»‡',
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åŠ å…¥æ—¶é—´',
    status VARCHAR(20) DEFAULT 'active' COMMENT 'çŠ¶æ€ï¼šactive/inactive/pending',
    invited_by VARCHAR(50) COMMENT 'é‚€è¯·äººID',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_org (user_id, organization_id),
    INDEX idx_user_orgs_user (user_id),
    INDEX idx_user_orgs_org (organization_id),
    INDEX idx_user_orgs_primary (user_id, is_primary)
);
```

### 3. ç»„ç»‡è¡¨ (organizations) - æ–°å»ºï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

```sql
CREATE TABLE organizations (
    id VARCHAR(50) PRIMARY KEY COMMENT 'ç»„ç»‡ID',
    name VARCHAR(100) NOT NULL COMMENT 'è‹±æ–‡åç§°',
    display_name_zh VARCHAR(100) COMMENT 'ä¸­æ–‡æ˜¾ç¤ºå',
    display_name_en VARCHAR(100) COMMENT 'è‹±æ–‡æ˜¾ç¤ºå',
    school_id VARCHAR(50) COMMENT 'æ‰€å±å­¦æ ¡ID',
    logo_url VARCHAR(255) COMMENT 'ç»„ç»‡Logo',
    description TEXT COMMENT 'ç»„ç»‡æè¿°',
    contact_email VARCHAR(100) COMMENT 'è”ç³»é‚®ç®±',
    website_url VARCHAR(255) COMMENT 'å®˜ç½‘é“¾æ¥',
    status VARCHAR(20) DEFAULT 'active' COMMENT 'active/inactive',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    INDEX idx_orgs_school (school_id),
    INDEX idx_orgs_status (status)
);
```

## ğŸ”Œ APIæ¥å£éœ€æ±‚

### 1. ç”¨æˆ·èº«ä»½ç›¸å…³æ¥å£

#### GET /api/users/{userId}/identity
è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼ˆç”¨äºç”Ÿæˆèº«ä»½ç ï¼‰

**å“åº”æ•°æ®ï¼š**
```json
{
  "userId": "user_123",
  "userName": "test007",
  "legalName": "æµ‹è¯•ç”¨æˆ·0017",
  "nickName": "testtest0017",
  "email": "user@example.com",
  "avatarUrl": "https://example.com/avatar.jpg",
  "studentId": "20240001",
  "currentOrganization": {
    "id": "org_columbia_cu",
    "name": "Columbia CU",
    "displayNameZh": "å“¥å¤§ä¸­å›½å­¦ç”Ÿå­¦è€…è”è°Šä¼š",
    "logoUrl": "https://example.com/org-logo.jpg"
  },
  "memberOrganizations": [
    {
      "id": "org_columbia_cu",
      "role": "member",
      "isPrimary": true,
      "joinedAt": "2024-01-15T10:00:00Z"
    }
  ]
}
```

#### POST /api/identity/verify
éªŒè¯èº«ä»½ç å¹¶è¿”å›ç”¨æˆ·æ¡£æ¡ˆ

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "identityCode": "VG_USER_eyJ1c2VySWQiOiJ1c2VyXzEyMyIsInVzZXJOYW1lIjoidGVzdDA...",
  "scannerUserId": "scanner_user_456",
  "scannerOrganizationId": "org_columbia_cu"
}
```

**å“åº”æ•°æ®ï¼š**
```json
{
  "isValid": true,
  "user": {
    "userId": "user_123",
    "legalName": "æµ‹è¯•ç”¨æˆ·0017",
    "nickName": "testtest0017",
    "email": "user@example.com",
    "avatarUrl": "https://example.com/avatar.jpg",
    "currentOrganization": {
      "id": "org_columbia_cu",
      "displayNameZh": "å“¥å¤§ä¸­å›½å­¦ç”Ÿå­¦è€…è”è°Šä¼š"
    },
    "activityStats": {
      "totalParticipated": 8,
      "volunteeredHours": 24,
      "points": 1680
    }
  },
  "permissions": {
    "canViewDetails": true,
    "canViewContact": true,
    "canViewActivities": true
  },
  "recentActivities": [
    {
      "id": "activity_001",
      "title": "CUæ˜¥å­£è¿æ–°æ´¾å¯¹",
      "participatedAt": "2024-08-10T19:00:00Z",
      "role": "participant"
    }
  ]
}
```

### 2. ç»„ç»‡ç®¡ç†ç›¸å…³æ¥å£

#### GET /api/users/{userId}/organizations
è·å–ç”¨æˆ·æ‰€æœ‰ç»„ç»‡

#### POST /api/users/{userId}/organizations
ç”¨æˆ·åŠ å…¥æ–°ç»„ç»‡

#### PUT /api/users/{userId}/organizations/{orgId}/primary
è®¾ç½®ä¸»è¦ç»„ç»‡

#### POST /api/users/{userId}/organizations/{orgId}/switch
åˆ‡æ¢å½“å‰æ´»è·ƒç»„ç»‡

## ğŸ¯ æ•°æ®è¿ç§»è„šæœ¬

### 1. åˆå§‹åŒ–ç°æœ‰ç”¨æˆ·çš„ç»„ç»‡æ•°æ®

```sql
-- ä¸ºç°æœ‰ç”¨æˆ·åˆ›å»ºé»˜è®¤ç»„ç»‡å…³è”ï¼ˆå‡è®¾æœ‰é»˜è®¤ç»„ç»‡ï¼‰
INSERT INTO user_organizations (id, user_id, organization_id, role, is_primary, status)
SELECT 
    CONCAT('uo_', users.id, '_default'),
    users.id,
    'org_default',  -- æ›¿æ¢ä¸ºå®é™…çš„é»˜è®¤ç»„ç»‡ID
    'member',
    true,
    'active'
FROM users 
WHERE users.id NOT IN (SELECT user_id FROM user_organizations);

-- æ›´æ–°ç”¨æˆ·è¡¨çš„å½“å‰ç»„ç»‡ID
UPDATE users 
SET current_organization_id = 'org_default'  -- æ›¿æ¢ä¸ºå®é™…çš„é»˜è®¤ç»„ç»‡ID
WHERE current_organization_id IS NULL;
```

### 2. åˆ›å»ºç¤ºä¾‹ç»„ç»‡æ•°æ®

```sql
INSERT INTO organizations (id, name, display_name_zh, display_name_en, status) VALUES
('org_columbia_cu', 'Columbia CU', 'å“¥å¤§ä¸­å›½å­¦ç”Ÿå­¦è€…è”è°Šä¼š', 'Columbia Chinese Union', 'active'),
('org_cssa', 'CSSA', 'ä¸­å›½å­¦ç”Ÿå­¦è€…è”è°Šä¼š', 'Chinese Students and Scholars Association', 'active'),
('org_nyu_gsu', 'NYU GSU', 'NYUä¸­å›½å­¦ç”Ÿä¼š', 'NYU Chinese Graduate Student Union', 'active');
```

## ğŸ” æƒé™æ§åˆ¶é€»è¾‘

### èº«ä»½ç éªŒè¯æƒé™ç­‰çº§

1. **åŒç»„ç»‡æˆå‘˜**
   - æ˜¾ç¤ºè¯¦ç»†ä¸ªäººä¿¡æ¯
   - æ˜¾ç¤ºå®Œæ•´æ´»åŠ¨è®°å½•
   - æ˜¾ç¤ºè”ç³»æ–¹å¼

2. **ä¸åŒç»„ç»‡æˆå‘˜** 
   - æ˜¾ç¤ºåŸºæœ¬ä¸ªäººä¿¡æ¯
   - æ˜¾ç¤ºå…¬å¼€æ´»åŠ¨è®°å½•
   - éšè—è”ç³»æ–¹å¼

3. **ç»„ç»‡ç®¡ç†å‘˜**
   - æ˜¾ç¤ºå®Œæ•´ç”¨æˆ·æ¡£æ¡ˆ
   - æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
   - æ˜¾ç¤ºç®¡ç†æ“ä½œé€‰é¡¹

4. **éç»„ç»‡æˆå‘˜**
   - åªæ˜¾ç¤ºå…¬å¼€çš„åŸºæœ¬ä¿¡æ¯
   - ä¸æ˜¾ç¤ºæ´»åŠ¨è®°å½•

## ğŸ“Š ç»Ÿè®¡æ•°æ®è®¡ç®—

ä¸ºèº«ä»½ç éªŒè¯æä¾›çš„ç”¨æˆ·ç»Ÿè®¡æ•°æ®ï¼š

```sql
-- ç”¨æˆ·æ´»åŠ¨ç»Ÿè®¡æŸ¥è¯¢ç¤ºä¾‹
SELECT 
    u.id as user_id,
    COUNT(ar.id) as total_participated,
    COALESCE(SUM(ar.volunteer_hours), 0) as total_volunteer_hours,
    COALESCE(SUM(ar.points_earned), 0) as total_points
FROM users u
LEFT JOIN activity_registrations ar ON u.id = ar.user_id 
WHERE u.id = ? AND ar.status = 'completed'
GROUP BY u.id;
```

## ğŸš€ å®æ–½ä¼˜å…ˆçº§

### Phase 1 (ç«‹å³å®æ–½)
- æ·»åŠ  `current_organization_id` å­—æ®µ
- åˆ›å»º `user_organizations` è¡¨
- å®ç°åŸºç¡€çš„èº«ä»½éªŒè¯API

### Phase 2 (åç»­ä¼˜åŒ–)
- æ·»åŠ å¤´åƒå’Œå­¦å·å­—æ®µ
- å®Œå–„æƒé™æ§åˆ¶é€»è¾‘
- å®ç°ç»Ÿè®¡æ•°æ®è®¡ç®—

### Phase 3 (æ‰©å±•åŠŸèƒ½)
- ç»„ç»‡é‚€è¯·åŠŸèƒ½
- é«˜çº§æƒé™ç®¡ç†
- å®¡è®¡æ—¥å¿—