# 身份识别码功能 - 后端更新需求

## 📋 数据库结构更新

### 1. 用户表 (users) 新增字段

基于现有字段，需要添加以下字段：

```sql
-- 组织相关（必需）
ALTER TABLE users ADD COLUMN current_organization_id VARCHAR(50) COMMENT '当前活跃的学联组织ID';

-- 身份识别相关（推荐）
ALTER TABLE users ADD COLUMN avatar_url VARCHAR(255) COMMENT '头像图片URL';
ALTER TABLE users ADD COLUMN student_id VARCHAR(50) COMMENT '学号';
ALTER TABLE users ADD COLUMN status VARCHAR(20) DEFAULT 'active' COMMENT '用户状态：active/inactive/suspended';

-- 系统管理相关（推荐）
ALTER TABLE users ADD COLUMN email_verified BOOLEAN DEFAULT false COMMENT '邮箱验证状态';
ALTER TABLE users ADD COLUMN created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间';
ALTER TABLE users ADD COLUMN updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间';

-- 添加索引
CREATE INDEX idx_users_current_org ON users(current_organization_id);
CREATE INDEX idx_users_status ON users(status);
```

### 2. 用户-组织关联表 (user_organizations) - 新建

```sql
CREATE TABLE user_organizations (
    id VARCHAR(50) PRIMARY KEY COMMENT '关联ID',
    user_id VARCHAR(50) NOT NULL COMMENT '用户ID',
    organization_id VARCHAR(50) NOT NULL COMMENT '组织ID',
    role VARCHAR(20) DEFAULT 'member' COMMENT '角色：member/admin/super_admin',
    is_primary BOOLEAN DEFAULT false COMMENT '是否为主要组织',
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '加入时间',
    status VARCHAR(20) DEFAULT 'active' COMMENT '状态：active/inactive/pending',
    invited_by VARCHAR(50) COMMENT '邀请人ID',
    
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY unique_user_org (user_id, organization_id),
    INDEX idx_user_orgs_user (user_id),
    INDEX idx_user_orgs_org (organization_id),
    INDEX idx_user_orgs_primary (user_id, is_primary)
);
```

### 3. 组织表 (organizations) - 新建（如果还没有）

```sql
CREATE TABLE organizations (
    id VARCHAR(50) PRIMARY KEY COMMENT '组织ID',
    name VARCHAR(100) NOT NULL COMMENT '英文名称',
    display_name_zh VARCHAR(100) COMMENT '中文显示名',
    display_name_en VARCHAR(100) COMMENT '英文显示名',
    school_id VARCHAR(50) COMMENT '所属学校ID',
    logo_url VARCHAR(255) COMMENT '组织Logo',
    description TEXT COMMENT '组织描述',
    contact_email VARCHAR(100) COMMENT '联系邮箱',
    website_url VARCHAR(255) COMMENT '官网链接',
    status VARCHAR(20) DEFAULT 'active' COMMENT 'active/inactive',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_orgs_school (school_id),
    INDEX idx_orgs_status (status)
);
```

## 🔌 API接口需求

### 1. 用户身份相关接口

#### GET /api/users/{userId}/identity
获取用户身份信息（用于生成身份码）

**响应数据：**
```json
{
  "userId": "user_123",
  "userName": "test007",
  "legalName": "测试用户0017",
  "nickName": "testtest0017",
  "email": "user@example.com",
  "avatarUrl": "https://example.com/avatar.jpg",
  "studentId": "20240001",
  "currentOrganization": {
    "id": "org_columbia_cu",
    "name": "Columbia CU",
    "displayNameZh": "哥大中国学生学者联谊会",
    "logoUrl": "https://example.com/org-logo.jpg"
  },
  "memberOrganizations": [
    {
      "id": "org_columbia_cu",
      "role": "member",
      "isPrimary": true,
      "joinedAt": "2024-01-15T10:00:00Z"
    }
  ]
}
```

#### POST /api/identity/verify
验证身份码并返回用户档案

**请求参数：**
```json
{
  "identityCode": "VG_USER_eyJ1c2VySWQiOiJ1c2VyXzEyMyIsInVzZXJOYW1lIjoidGVzdDA...",
  "scannerUserId": "scanner_user_456",
  "scannerOrganizationId": "org_columbia_cu"
}
```

**响应数据：**
```json
{
  "isValid": true,
  "user": {
    "userId": "user_123",
    "legalName": "测试用户0017",
    "nickName": "testtest0017",
    "email": "user@example.com",
    "avatarUrl": "https://example.com/avatar.jpg",
    "currentOrganization": {
      "id": "org_columbia_cu",
      "displayNameZh": "哥大中国学生学者联谊会"
    },
    "activityStats": {
      "totalParticipated": 8,
      "volunteeredHours": 24,
      "points": 1680
    }
  },
  "permissions": {
    "canViewDetails": true,
    "canViewContact": true,
    "canViewActivities": true
  },
  "recentActivities": [
    {
      "id": "activity_001",
      "title": "CU春季迎新派对",
      "participatedAt": "2024-08-10T19:00:00Z",
      "role": "participant"
    }
  ]
}
```

### 2. 组织管理相关接口

#### GET /api/users/{userId}/organizations
获取用户所有组织

#### POST /api/users/{userId}/organizations
用户加入新组织

#### PUT /api/users/{userId}/organizations/{orgId}/primary
设置主要组织

#### POST /api/users/{userId}/organizations/{orgId}/switch
切换当前活跃组织

## 🎯 数据迁移脚本

### 1. 初始化现有用户的组织数据

```sql
-- 为现有用户创建默认组织关联（假设有默认组织）
INSERT INTO user_organizations (id, user_id, organization_id, role, is_primary, status)
SELECT 
    CONCAT('uo_', users.id, '_default'),
    users.id,
    'org_default',  -- 替换为实际的默认组织ID
    'member',
    true,
    'active'
FROM users 
WHERE users.id NOT IN (SELECT user_id FROM user_organizations);

-- 更新用户表的当前组织ID
UPDATE users 
SET current_organization_id = 'org_default'  -- 替换为实际的默认组织ID
WHERE current_organization_id IS NULL;
```

### 2. 创建示例组织数据

```sql
INSERT INTO organizations (id, name, display_name_zh, display_name_en, status) VALUES
('org_columbia_cu', 'Columbia CU', '哥大中国学生学者联谊会', 'Columbia Chinese Union', 'active'),
('org_cssa', 'CSSA', '中国学生学者联谊会', 'Chinese Students and Scholars Association', 'active'),
('org_nyu_gsu', 'NYU GSU', 'NYU中国学生会', 'NYU Chinese Graduate Student Union', 'active');
```

## 🔐 权限控制逻辑

### 身份码验证权限等级

1. **同组织成员**
   - 显示详细个人信息
   - 显示完整活动记录
   - 显示联系方式

2. **不同组织成员** 
   - 显示基本个人信息
   - 显示公开活动记录
   - 隐藏联系方式

3. **组织管理员**
   - 显示完整用户档案
   - 显示统计数据
   - 显示管理操作选项

4. **非组织成员**
   - 只显示公开的基本信息
   - 不显示活动记录

## 📊 统计数据计算

为身份码验证提供的用户统计数据：

```sql
-- 用户活动统计查询示例
SELECT 
    u.id as user_id,
    COUNT(ar.id) as total_participated,
    COALESCE(SUM(ar.volunteer_hours), 0) as total_volunteer_hours,
    COALESCE(SUM(ar.points_earned), 0) as total_points
FROM users u
LEFT JOIN activity_registrations ar ON u.id = ar.user_id 
WHERE u.id = ? AND ar.status = 'completed'
GROUP BY u.id;
```

## 🚀 实施优先级

### Phase 1 (立即实施)
- 添加 `current_organization_id` 字段
- 创建 `user_organizations` 表
- 实现基础的身份验证API

### Phase 2 (后续优化)
- 添加头像和学号字段
- 完善权限控制逻辑
- 实现统计数据计算

### Phase 3 (扩展功能)
- 组织邀请功能
- 高级权限管理
- 审计日志