# 后端商家会员卡功能实现需求文档

## 📋 功能概述

本文档描述了支持多学联组织架构的商家会员卡系统后端实现需求，包括组织管理、权限控制、会员卡生成和Apple Wallet集成等核心功能。

## 🏗️ 数据库设计

### 1. 组织表 (organizations)
```sql
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,                    -- 组织名称
    display_name_zh VARCHAR(255) NOT NULL,         -- 中文显示名
    display_name_en VARCHAR(255) NOT NULL,         -- 英文显示名
    slug VARCHAR(100) UNIQUE NOT NULL,             -- URL友好标识
    region VARCHAR(100) NOT NULL,                  -- 地区 (US-NY, US-CA, etc.)
    logo_url VARCHAR(500),                         -- Logo图片URL
    brand_colors JSONB NOT NULL DEFAULT '{}',     -- 品牌色彩配置
    contact_info JSONB,                           -- 联系信息
    member_count INTEGER DEFAULT 0,               -- 成员数量
    is_active BOOLEAN DEFAULT true,               -- 是否启用
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 示例数据
INSERT INTO organizations (name, display_name_zh, display_name_en, slug, region, brand_colors) VALUES
('Columbia CSSA', '哥伦比亚大学中国学生学者联谊会', 'Columbia Chinese Students and Scholars Association', 'columbia-cssa', 'US-NY', '{"primary": "#1E40AF", "secondary": "#DBEAFE"}'),
('NYU GSU', '纽约大学中国学生会', 'NYU Graduate Student Union Chinese Chapter', 'nyu-gsu', 'US-NY', '{"primary": "#7C3AED", "secondary": "#EDE9FE"}');
```

### 2. 商家表 (merchants)
```sql
CREATE TABLE merchants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,                    -- 商家名称
    category VARCHAR(100) NOT NULL,               -- 类别: dining, retail, service, education
    description TEXT,                             -- 描述
    logo_url VARCHAR(500),                        -- Logo URL
    brand_colors JSONB DEFAULT '{}',              -- 品牌色彩
    address TEXT,                                 -- 地址
    phone VARCHAR(50),                            -- 电话
    website VARCHAR(255),                         -- 网站
    qr_code_pattern VARCHAR(255) UNIQUE,          -- QR码模式
    business_hours JSONB,                         -- 营业时间
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3. 组织-商家合作关系表 (organization_merchant_partnerships)
```sql
CREATE TABLE organization_merchant_partnerships (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    merchant_id UUID REFERENCES merchants(id) ON DELETE CASCADE,
    partnership_type VARCHAR(50) DEFAULT 'standard', -- standard, premium, exclusive
    discount_rate DECIMAL(5,2),                      -- 折扣率
    special_benefits JSONB,                          -- 特殊权益
    start_date DATE,                                 -- 合作开始日期
    end_date DATE,                                   -- 合作结束日期
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(organization_id, merchant_id)
);
```

### 4. 用户组织关系表 (user_organizations)
```sql
CREATE TABLE user_organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    membership_level VARCHAR(50) DEFAULT 'basic',    -- basic, premium, vip
    member_number VARCHAR(100),                      -- 会员编号
    join_date DATE DEFAULT CURRENT_DATE,             -- 加入日期
    is_current BOOLEAN DEFAULT false,                -- 当前激活组织
    is_active BOOLEAN DEFAULT true,                  -- 会员状态
    verification_status VARCHAR(50) DEFAULT 'pending', -- pending, verified, rejected
    verification_data JSONB,                         -- 验证材料
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, organization_id)
);
```

### 5. 会员卡表 (membership_cards)
```sql
CREATE TABLE membership_cards (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    organization_id UUID REFERENCES organizations(id),  -- 组织会员卡
    merchant_id UUID REFERENCES merchants(id),          -- 商家会员卡(可为空)
    card_type VARCHAR(50) NOT NULL,                     -- organization, merchant
    card_number VARCHAR(100) UNIQUE NOT NULL,           -- 卡号
    display_name VARCHAR(255),                          -- 显示名称
    points INTEGER DEFAULT 0,                           -- 积分
    membership_level VARCHAR(50) DEFAULT 'basic',       -- 会员等级
    qr_code_data TEXT,                                  -- 二维码数据
    apple_wallet_pass_id VARCHAR(255),                 -- Apple Wallet Pass ID
    google_wallet_object_id VARCHAR(255),              -- Google Wallet Object ID
    last_used_at TIMESTAMP,                            -- 最后使用时间
    expires_at TIMESTAMP,                              -- 过期时间
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 添加索引
CREATE INDEX idx_membership_cards_user_id ON membership_cards(user_id);
CREATE INDEX idx_membership_cards_organization_id ON membership_cards(organization_id);
CREATE INDEX idx_membership_cards_merchant_id ON membership_cards(merchant_id);
CREATE INDEX idx_membership_cards_card_number ON membership_cards(card_number);
```

### 6. 积分交易记录表 (points_transactions)
```sql
CREATE TABLE points_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    card_id UUID REFERENCES membership_cards(id) ON DELETE CASCADE,
    transaction_type VARCHAR(50) NOT NULL,             -- earn, redeem, transfer, expire
    points_change INTEGER NOT NULL,                    -- 积分变化(正负数)
    description VARCHAR(255),                          -- 交易描述
    reference_id VARCHAR(255),                         -- 关联ID(订单、活动等)
    merchant_id UUID REFERENCES merchants(id),         -- 相关商家
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 🔧 API 端点设计

### 1. 组织管理 API

#### 获取用户可用组织列表
```python
@app.get("/api/organizations/user/{user_id}")
async def get_user_organizations(user_id: str):
    """
    返回用户加入的所有组织，包括当前激活状态
    Response:
    {
        "organizations": [
            {
                "id": "uuid",
                "name": "Columbia CSSA",
                "display_name_zh": "哥伦比亚大学中国学生学者联谊会",
                "display_name_en": "Columbia Chinese Students and Scholars Association",
                "logo_url": "https://...",
                "brand_colors": {"primary": "#1E40AF", "secondary": "#DBEAFE"},
                "membership_level": "basic",
                "is_current": true,
                "member_number": "CSSA2024001"
            }
        ]
    }
    """
```

#### 切换当前组织
```python
@app.post("/api/organizations/switch")
async def switch_organization(request: SwitchOrganizationRequest):
    """
    切换用户的当前激活组织
    Request:
    {
        "user_id": "uuid",
        "organization_id": "uuid"
    }
    Response:
    {
        "success": true,
        "message": "组织切换成功",
        "current_organization": {...}
    }
    """
```

### 2. 商家管理 API

#### 获取组织合作商家列表
```python
@app.get("/api/merchants/organization/{organization_id}")
async def get_organization_merchants(organization_id: str, category: str = None):
    """
    获取指定组织的合作商家列表
    Response:
    {
        "merchants": [
            {
                "id": "uuid",
                "name": "Starbucks Coffee",
                "category": "dining",
                "logo_url": "https://...",
                "brand_colors": {"primary": "#00704A", "secondary": "#FFFFFF"},
                "partnership_info": {
                    "discount_rate": 10.00,
                    "special_benefits": ["免费升杯", "生日特饮"]
                }
            }
        ]
    }
    """
```

#### 验证商家QR码
```python
@app.post("/api/merchants/verify-qr")
async def verify_merchant_qr(request: VerifyQRRequest):
    """
    验证商家QR码并检查用户权限
    Request:
    {
        "qr_data": "vitaglobal://merchant/starbucks-001/location/001",
        "user_id": "uuid",
        "organization_id": "uuid"
    }
    Response:
    {
        "valid": true,
        "merchant": {...},
        "has_permission": true,
        "partnership_info": {...}
    }
    """
```

### 3. 会员卡管理 API

#### 获取用户会员卡列表
```python
@app.get("/api/cards/user/{user_id}")
async def get_user_membership_cards(
    user_id: str, 
    organization_id: str = None, 
    card_type: str = None
):
    """
    获取用户的所有会员卡，支持按组织和类型筛选
    Response:
    {
        "cards": [
            {
                "id": "uuid",
                "card_type": "organization",
                "organization": {...},
                "card_number": "CSSA2024001",
                "points": 1250,
                "membership_level": "basic",
                "qr_code_data": "encoded_data",
                "created_at": "2024-01-01T00:00:00Z"
            },
            {
                "id": "uuid", 
                "card_type": "merchant",
                "merchant": {...},
                "organization": {...},
                "card_number": "SB001234567",
                "points": 480,
                "membership_level": "basic"
            }
        ]
    }
    """
```

#### 创建商家会员卡
```python
@app.post("/api/cards/create-merchant-card")
async def create_merchant_card(request: CreateMerchantCardRequest):
    """
    扫码创建商家会员卡
    Request:
    {
        "user_id": "uuid",
        "organization_id": "uuid", 
        "merchant_id": "uuid",
        "qr_data": "scanned_qr_code_data"
    }
    Response:
    {
        "success": true,
        "card": {
            "id": "uuid",
            "card_number": "generated_number",
            "merchant": {...},
            "qr_code_data": "encoded_card_data"
        },
        "apple_wallet_pass_url": "https://api.vitaglobal.com/passes/uuid.pkpass"
    }
    """
```

#### 更新会员卡积分
```python
@app.post("/api/cards/{card_id}/points")
async def update_card_points(card_id: str, request: UpdatePointsRequest):
    """
    更新会员卡积分（消费、奖励等）
    Request:
    {
        "points_change": 50,
        "transaction_type": "earn",
        "description": "消费获得积分",
        "merchant_id": "uuid",
        "reference_id": "order_123"
    }
    """
```

### 4. Apple Wallet 集成 API

#### 生成 Apple Wallet Pass
```python
@app.post("/api/wallet/generate-pass/{card_id}")
async def generate_apple_wallet_pass(card_id: str):
    """
    为指定会员卡生成Apple Wallet Pass文件
    Response:
    {
        "pass_url": "https://api.vitaglobal.com/passes/uuid.pkpass",
        "expires_at": "2024-12-31T23:59:59Z"
    }
    """
```

#### Pass 更新回调
```python
@app.post("/api/wallet/passes/{pass_id}/update")
async def update_pass_callback(pass_id: str, request: PassUpdateRequest):
    """
    Apple Wallet Pass更新回调处理
    当积分或会员信息变更时，推送更新到用户的Apple Wallet
    """
```

## 🛡️ 权限控制逻辑

### 1. 组织权限验证
```python
def verify_organization_access(user_id: str, organization_id: str) -> bool:
    """验证用户是否有权限访问指定组织"""
    user_org = db.query(UserOrganization).filter(
        UserOrganization.user_id == user_id,
        UserOrganization.organization_id == organization_id,
        UserOrganization.is_active == True,
        UserOrganization.verification_status == 'verified'
    ).first()
    return user_org is not None
```

### 2. 商家扫码权限验证
```python
def verify_merchant_scan_permission(user_id: str, merchant_id: str) -> tuple[bool, str]:
    """验证用户是否有权限扫描指定商家的QR码"""
    # 获取用户当前激活的组织
    current_org = get_user_current_organization(user_id)
    if not current_org:
        return False, "用户未加入任何组织"
    
    # 检查组织与商家的合作关系
    partnership = db.query(OrganizationMerchantPartnership).filter(
        OrganizationMerchantPartnership.organization_id == current_org.id,
        OrganizationMerchantPartnership.merchant_id == merchant_id,
        OrganizationMerchantPartnership.is_active == True
    ).first()
    
    if not partnership:
        # 返回可选的其他组织
        available_orgs = get_merchant_partner_organizations(merchant_id, user_id)
        return False, f"当前组织无权限，可切换到: {[org.name for org in available_orgs]}"
    
    return True, "权限验证通过"
```

## 🔐 PassKit 证书配置

### 1. 证书文件结构
```
config/passkit/
├── pass_type_certificates/
│   ├── organization_pass.p12      # 组织会员卡证书
│   ├── merchant_pass.p12          # 商家会员卡证书
│   └── passkit_password.txt       # 证书密码
├── wwdr_certificate.pem           # Apple WWDR证书
└── pass_templates/
    ├── organization_pass.json     # 组织卡模板
    └── merchant_pass.json         # 商家卡模板
```

### 2. Pass 生成服务
```python
from passkit_generator import PassGenerator

class PassKitService:
    def __init__(self):
        self.wwdr_cert = load_certificate("config/passkit/wwdr_certificate.pem")
        self.pass_cert = load_certificate("config/passkit/pass_type_certificates/")
    
    def generate_organization_pass(self, card: MembershipCard) -> bytes:
        """生成组织会员卡Pass"""
        pass_data = {
            "passTypeIdentifier": f"pass.com.vitaglobal.org.{card.organization.slug}",
            "serialNumber": card.card_number,
            "organizationName": card.organization.name,
            "logoText": card.organization.display_name_zh,
            "foregroundColor": card.organization.brand_colors.get("primary", "#000000"),
            "backgroundColor": card.organization.brand_colors.get("secondary", "#FFFFFF"),
            "barcode": {
                "format": "PKBarcodeFormatQR",
                "message": card.qr_code_data,
                "messageEncoding": "iso-8859-1"
            },
            "storeCard": {
                "primaryFields": [
                    {"key": "points", "label": "积分", "value": str(card.points)}
                ],
                "secondaryFields": [
                    {"key": "level", "label": "等级", "value": card.membership_level},
                    {"key": "member_number", "label": "会员号", "value": card.card_number}
                ],
                "auxiliaryFields": [
                    {"key": "organization", "label": "组织", "value": card.organization.display_name_zh}
                ]
            }
        }
        
        return self.generate_pass(pass_data)
    
    def generate_merchant_pass(self, card: MembershipCard) -> bytes:
        """生成商家会员卡Pass"""
        pass_data = {
            "passTypeIdentifier": f"pass.com.vitaglobal.merchant.{card.merchant.id}",
            "serialNumber": card.card_number,
            "organizationName": card.merchant.name,
            "logoText": card.merchant.name,
            "foregroundColor": card.merchant.brand_colors.get("primary", "#000000"),
            "backgroundColor": card.merchant.brand_colors.get("secondary", "#FFFFFF"),
            "barcode": {
                "format": "PKBarcodeFormatQR",
                "message": card.qr_code_data,
                "messageEncoding": "iso-8859-1"
            },
            "storeCard": {
                "primaryFields": [
                    {"key": "points", "label": "积分", "value": str(card.points)}
                ],
                "secondaryFields": [
                    {"key": "level", "label": "等级", "value": card.membership_level},
                    {"key": "merchant", "label": "商家", "value": card.merchant.name}
                ],
                "auxiliaryFields": [
                    {"key": "organization", "label": "所属组织", "value": card.organization.display_name_zh}
                ]
            }
        }
        
        return self.generate_pass(pass_data)
```

## 📊 数据统计与分析

### 1. 组织统计数据
```python
@app.get("/api/analytics/organization/{organization_id}")
async def get_organization_analytics(organization_id: str):
    """
    获取组织的统计数据
    - 成员数量和增长趋势
    - 商家合作数量
    - 会员卡使用情况
    - 积分发放统计
    """
```

### 2. 商家统计数据
```python
@app.get("/api/analytics/merchant/{merchant_id}")
async def get_merchant_analytics(merchant_id: str):
    """
    获取商家的统计数据
    - 会员卡发放数量
    - 积分交易记录
    - 用户活跃度
    - 不同组织的用户分布
    """
```

## 🔄 数据同步与缓存

### 1. Redis 缓存策略
```python
# 缓存键设计
user_current_org_key = f"user:{user_id}:current_org"
org_merchants_key = f"org:{organization_id}:merchants"
user_cards_key = f"user:{user_id}:cards"

# 缓存过期时间
CACHE_TTL = {
    "user_current_org": 3600,      # 1小时
    "org_merchants": 1800,         # 30分钟
    "user_cards": 900,             # 15分钟
    "merchant_info": 3600          # 1小时
}
```

### 2. 数据一致性保证
```python
async def invalidate_user_cache(user_id: str):
    """用户数据变更时清除相关缓存"""
    await redis.delete(
        f"user:{user_id}:current_org",
        f"user:{user_id}:cards",
        f"user:{user_id}:organizations"
    )

async def invalidate_organization_cache(organization_id: str):
    """组织数据变更时清除相关缓存"""
    await redis.delete(f"org:{organization_id}:merchants")
```

## 🛠️ 开发环境配置

### 1. 环境变量
```bash
# PassKit 配置
PASSKIT_TEAM_IDENTIFIER=ABC123DEF4
PASSKIT_PASS_TYPE_IDENTIFIER=pass.com.vitaglobal
PASSKIT_CERTIFICATE_PATH=/config/passkit/certificates/
PASSKIT_CERTIFICATE_PASSWORD=your_certificate_password

# Apple Developer 配置
APPLE_DEVELOPER_ACCOUNT_ID=your_account_id
APPLE_PUSH_CERT_PATH=/config/passkit/push_cert.pem
APPLE_PUSH_CERT_KEY_PATH=/config/passkit/push_key.pem

# Redis 配置
REDIS_URL=redis://localhost:6379/0
REDIS_PASSWORD=your_redis_password

# 文件存储配置
CLOUDFLARE_R2_BUCKET=vitaglobal-passes
CLOUDFLARE_R2_ACCESS_KEY=your_access_key
CLOUDFLARE_R2_SECRET_KEY=your_secret_key
```

### 2. 依赖库
```txt
# requirements.txt 新增
passkit-generator==1.2.0
cryptography==41.0.7
redis==5.0.1
boto3==1.34.0  # for S3-compatible storage
qrcode==7.4.2
pillow==10.1.0
```

## 📋 部署清单

### 1. 数据库迁移脚本
- [ ] 创建组织相关表结构
- [ ] 创建会员卡管理表结构  
- [ ] 创建索引和约束
- [ ] 插入初始组织数据

### 2. PassKit 证书配置
- [ ] 申请Apple Developer账号
- [ ] 创建Pass Type ID
- [ ] 生成Pass证书文件
- [ ] 配置推送证书

### 3. API 端点实现
- [ ] 组织管理相关API
- [ ] 商家管理相关API
- [ ] 会员卡管理相关API
- [ ] PassKit集成API

### 4. 权限验证系统
- [ ] 实现组织权限验证
- [ ] 实现商家扫码权限验证
- [ ] 实现会员卡操作权限验证

### 5. 缓存与性能优化
- [ ] 配置Redis缓存策略
- [ ] 实现数据一致性保证
- [ ] 优化数据库查询性能

这个后端实现方案将为前端多学联组织架构和会员卡系统提供完整的数据支持和业务逻辑处理。