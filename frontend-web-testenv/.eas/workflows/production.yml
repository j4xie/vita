name: Production Release to TestFlight
description: è‡ªåŠ¨æ„å»ºiOSç‰ˆæœ¬å¹¶æäº¤åˆ°TestFlight

on:
  workflow_dispatch:
    inputs:
      version_increment:
        description: 'ç‰ˆæœ¬é€’å¢ç±»å‹'
        type: choice
        options:
          - patch  # 1.0.7 â†’ 1.0.8 (bugä¿®å¤)
          - minor  # 1.0.7 â†’ 1.1.0 (æ–°åŠŸèƒ½)
          - major  # 1.0.7 â†’ 2.0.0 (é‡å¤§æ›´æ–°)
        default: patch

jobs:
  build_and_submit_ios:
    name: æ„å»ºå¹¶æäº¤iOSç‰ˆæœ¬
    runs-on: eas-build-medium
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        
      - name: è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·
        run: |
          echo "é€’å¢ç‰ˆæœ¬å·ç±»å‹: ${{ inputs.version_increment }}"
          npm version ${{ inputs.version_increment }} --no-git-tag-version
          
          # è·å–æ–°ç‰ˆæœ¬å·
          NEW_VERSION=$(node -p "require('./app.json').expo.version")
          NEW_BUILD_NUMBER=$(node -p "require('./app.json').expo.ios.buildNumber")
          
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
          echo "æ–°æ„å»ºå·: $NEW_BUILD_NUMBER"
          
          # æ›´æ–°iOSåŸç”Ÿç‰ˆæœ¬å·ï¼Œé¿å…ç‰ˆæœ¬å†²çª
          sed -i '' "s/<string>.*<\/string>/<string>$NEW_VERSION<\/string>/g" ios/PomeloX/Info.plist | grep -A1 CFBundleShortVersionString | head -2
          sed -i '' "s/<string>.*<\/string>/<string>$NEW_BUILD_NUMBER<\/string>/g" ios/PomeloX/Info.plist | grep -A1 CFBundleVersion | head -2
          
      - name: æ„å»ºiOSåº”ç”¨
        id: build
        run: |
          eas build --platform ios --profile production --non-interactive --wait
        env:
          EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
          
      - name: æäº¤åˆ°TestFlight
        run: |
          eas submit --platform ios --profile production --latest --non-interactive
        env:
          EXPO_APPLE_ID: ${{ secrets.EXPO_APPLE_ID }}
          
      - name: é€šçŸ¥æ„å»ºå®Œæˆ
        run: |
          echo "âœ… ç‰ˆæœ¬ $NEW_VERSION å·²æˆåŠŸæ„å»ºå¹¶æäº¤åˆ°TestFlight!"
          echo "ğŸ é¢„è®¡5-10åˆ†é’Ÿååœ¨TestFlightä¸­å¯ç”¨"