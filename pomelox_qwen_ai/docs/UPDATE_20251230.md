# Pomelox Qwen AI - 2025å¹´12æœˆ30æ—¥æ›´æ–°æ–‡æ¡£

## ğŸ“‹ æ›´æ–°æ¦‚è¿°

**æ›´æ–°æ—¥æœŸ**: 2025-12-30
**æ›´æ–°å†…å®¹**: æ•°æ®åº“é›†æˆã€ç«¯åˆ°ç«¯ç”¨æˆ·æµç¨‹éªŒè¯ã€å‘é‡åŒ–å½’æ¡£éªŒè¯
**æµ‹è¯•çŠ¶æ€**: âœ… æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²éªŒè¯é€šè¿‡

---

## ğŸ¯ ä¸»è¦æ›´æ–°å†…å®¹

### 1. æ•°æ®åº“é›†æˆå®Œæˆ

æ–°å¢4å¼ æ•°æ®åº“è¡¨,å®ç°å®Œæ•´çš„ç”¨æˆ·å¯¹è¯å’ŒçŸ¥è¯†ç®¡ç†:

- `ai_chat_session` - AIèŠå¤©ä¼šè¯è¡¨
- `ai_chat_message` - AIèŠå¤©æ¶ˆæ¯è¡¨
- `ai_feedback` - AIåé¦ˆè¡¨
- `ai_knowledge_base` - AIçŸ¥è¯†åº“è¡¨

**å…³é”®ç‰¹æ€§**:
- âœ… å¤–é”®çº¦æŸç¡®ä¿æ•°æ®å®Œæ•´æ€§
- âœ… è½¯åˆ é™¤æœºåˆ¶(del_flag)
- âœ… æŒ‰ç”¨æˆ·(user_id)å’Œå­¦æ ¡(dept_id)éš”ç¦»æ•°æ®
- âœ… æ”¯æŒä¼šè¯å†å²æŸ¥è¯¢

### 2. APIæ¥å£æ‰©å±•

**ä¿®æ”¹çš„æ¥å£**:
- `POST /ask` - æ–°å¢ç”¨æˆ·å…³è”å’Œæ•°æ®åº“æŒä¹…åŒ–

**æ–°å¢çš„æ¥å£**:
- `GET /api/ai/sessions` - è·å–ç”¨æˆ·ä¼šè¯åˆ—è¡¨
- `GET /api/ai/session/<id>/messages` - è·å–ä¼šè¯æ¶ˆæ¯
- `DELETE /api/ai/session/<id>` - åˆ é™¤ç”¨æˆ·ä¼šè¯

### 3. å‘é‡åŒ–å½’æ¡£æµç¨‹éªŒè¯

å®Œæ•´éªŒè¯äº†çŸ¥è¯†ä»æ•°æ®åº“åˆ°å‘é‡åº“çš„å½’æ¡£æµç¨‹:

```
ç”¨æˆ·åé¦ˆ â†’ æ•°æ®åº“(indexed=0) â†’ å½’æ¡£è„šæœ¬ â†’
å‘é‡åº“æ›´æ–° â†’ æ•°æ®åº“æ›´æ–°(indexed=1) â†’ å‘é‡æ£€ç´¢æˆåŠŸ
```

**å·²éªŒè¯**:
- âœ… å¢é‡å‘é‡åŒ–(ä¸é‡å»ºæ•´ä¸ªç´¢å¼•)
- âœ… æ··åˆæ£€ç´¢(å‘é‡åº“ + æ•°æ®åº“æœªå½’æ¡£çŸ¥è¯†)
- âœ… æ–‡ä»¶å®é™…æ›´æ–°(æ—¶é—´æˆ³å’Œå¤§å°å˜åŒ–)
- âœ… æ•°æ®åº“çŠ¶æ€åŒæ­¥

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### ç«¯åˆ°ç«¯ç”¨æˆ·æµç¨‹æµ‹è¯•

**æµ‹è¯•åœºæ™¯**: å®Œæ•´æ¨¡æ‹Ÿç”¨æˆ·ä»æé—®åˆ°çŸ¥è¯†å½’æ¡£çš„å…¨æµç¨‹

**æµ‹è¯•æ—¥æœŸ**: 2025-12-30 22:46-22:57

#### æµ‹è¯•æ­¥éª¤

1. **åˆ›å»ºæµ‹è¯•çŸ¥è¯†åˆ°æ•°æ®åº“** (indexed=0)
   - âœ… çŸ¥è¯†ID: manual_test_4e95d6a2
   - âœ… é—®é¢˜: "Manual demo question: UCSD library weekend hours?"
   - âœ… ç­”æ¡ˆ: "UCSD library weekend hours are 9am to 10pm."

2. **è¿è¡Œå½’æ¡£è„šæœ¬**
   ```bash
   python scripts/archive_to_vector.py --dept 216
   ```
   - âœ… å‘ç° 4 æ¡æ–°çŸ¥è¯†éœ€è¦å½’æ¡£
   - âœ… å¢é‡æ·»åŠ åˆ°å‘é‡ç´¢å¼•
   - âœ… ç´¢å¼•æ–‡ä»¶ä¿å­˜æˆåŠŸ

3. **éªŒè¯å‘é‡æ–‡ä»¶æ›´æ–°**

   | æ–‡ä»¶ | å½’æ¡£å‰ | å½’æ¡£å | å˜åŒ– |
   |------|-------|-------|------|
   | default__vector_store.json | 102K (15:48) | 238K (22:48) | **+136K** âœ… |
   | docstore.json | 15K (15:48) | 22K (22:48) | **+7K** âœ… |
   | index_store.json | 499B (15:48) | 835B (22:48) | **+336B** âœ… |

4. **æ›´æ–°æ•°æ®åº“çŠ¶æ€**
   - âœ… indexed: False â†’ True
   - âœ… 4æ¡çŸ¥è¯†å…¨éƒ¨æ ‡è®°ä¸ºå·²å½’æ¡£

5. **ä»å‘é‡åº“æ£€ç´¢éªŒè¯**
   ```
   é—®é¢˜: "UCSD library weekend hours?"
   RAGåˆ†æ•°: 0.748 (é«˜è´¨é‡)
   æ£€ç´¢ç»“æœ: "UCSD library weekend hours are 9am to 10pm."
   ```
   - âœ… æˆåŠŸä»å‘é‡åº“æ£€ç´¢åˆ°å½’æ¡£çš„çŸ¥è¯†
   - âœ… æ··åˆæ£€ç´¢: å‘é‡5æ¡, æ•°æ®åº“0æ¡

#### æµ‹è¯•ç»“è®º

ğŸ‰ **æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éªŒè¯é€šè¿‡**

å®Œæ•´æ•°æ®æµå·²éªŒè¯:
```
åˆ›å»ºçŸ¥è¯†(indexed=0) â†’ è¿è¡Œå½’æ¡£ â†’ å‘é‡æ–‡ä»¶æ›´æ–° â†’
æ•°æ®åº“æ›´æ–°(indexed=1) â†’ å‘é‡æ£€ç´¢æˆåŠŸ âœ…
```

---

## ğŸ“‚ æ•°æ®åº“è¡¨ç»“æ„

### ai_chat_session (èŠå¤©ä¼šè¯è¡¨)

```sql
CREATE TABLE ai_chat_session (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    session_id VARCHAR(100) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL,
    dept_id BIGINT NOT NULL,
    title VARCHAR(200) DEFAULT 'æ–°å¯¹è¯',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    del_flag CHAR(1) DEFAULT '0',
    FOREIGN KEY (user_id) REFERENCES sys_user(user_id),
    FOREIGN KEY (dept_id) REFERENCES sys_dept(dept_id)
);
```

### ai_chat_message (èŠå¤©æ¶ˆæ¯è¡¨)

```sql
CREATE TABLE ai_chat_message (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    message_id VARCHAR(100) NOT NULL UNIQUE,
    session_id VARCHAR(100) NOT NULL,
    user_id BIGINT NOT NULL,
    role VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    rag_score DECIMAL(5,3) DEFAULT NULL,
    source_type VARCHAR(30) DEFAULT 'knowledge_base',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES sys_user(user_id),
    FOREIGN KEY (session_id) REFERENCES ai_chat_session(session_id)
);
```

### ai_feedback (åé¦ˆè¡¨)

```sql
CREATE TABLE ai_feedback (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    feedback_id VARCHAR(50) NOT NULL UNIQUE,
    session_id VARCHAR(100) NOT NULL,
    message_id VARCHAR(100) NOT NULL,
    user_id BIGINT NOT NULL,
    dept_id BIGINT NOT NULL,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    rating TINYINT NOT NULL,
    rag_score DECIMAL(5,3) DEFAULT 0.000,
    source_type VARCHAR(30) DEFAULT 'knowledge_base',
    status VARCHAR(20) NOT NULL DEFAULT 'recorded',
    confidence_score DECIMAL(5,3) DEFAULT NULL,
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES sys_user(user_id),
    FOREIGN KEY (session_id) REFERENCES ai_chat_session(session_id)
);
```

### ai_knowledge_base (çŸ¥è¯†åº“è¡¨)

```sql
CREATE TABLE ai_knowledge_base (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    kb_id VARCHAR(50) NOT NULL UNIQUE,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    dept_id BIGINT NOT NULL,
    category VARCHAR(50) DEFAULT NULL,
    source VARCHAR(30) NOT NULL DEFAULT 'user_feedback',
    feedback_id VARCHAR(50) DEFAULT NULL,
    quality_score DECIMAL(5,3) DEFAULT 0.700,
    enabled CHAR(1) DEFAULT '1',
    indexed CHAR(1) DEFAULT '0',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (dept_id) REFERENCES sys_dept(dept_id),
    FOREIGN KEY (feedback_id) REFERENCES ai_feedback(feedback_id)
);
```

---

## ğŸ”§ ä¸»è¦ä¿®æ”¹æ–‡ä»¶

### 1. `app.py`

**ä¿®æ”¹å†…å®¹**:
- æ·»åŠ æ•°æ®åº“ä¿å­˜é€»è¾‘åˆ° `/ask` æ¥å£
- æ–°å¢3ä¸ªä¼šè¯ç®¡ç†APIè·¯ç”±
- æ·»åŠ  message_id ç”Ÿæˆå’Œè¿”å›

**å…³é”®ä»£ç **:
```python
# Save to database
if user_id:
    db = get_database()
    db.create_chat_session(session_id, user_id, dept_id, title)
    db.save_chat_message(user_msg_id, session_id, user_id, 'user', question, ...)
    db.save_chat_message(assistant_msg_id, session_id, user_id, 'assistant', answer, ...)
```

### 2. `database/mysql_impl.py`

**æ–°å¢æ–¹æ³•**:
- `create_chat_session()` - åˆ›å»ºèŠå¤©ä¼šè¯
- `get_user_chat_sessions()` - è·å–ç”¨æˆ·ä¼šè¯åˆ—è¡¨
- `save_chat_message()` - ä¿å­˜èŠå¤©æ¶ˆæ¯
- `get_chat_messages()` - è·å–ä¼šè¯æ¶ˆæ¯
- `delete_chat_session()` - åˆ é™¤ä¼šè¯(è½¯åˆ é™¤)

### 3. `scripts/archive_to_vector.py`

**åŠŸèƒ½**: å°†æ•°æ®åº“ä¸­æœªå½’æ¡£çš„çŸ¥è¯†(indexed=0)å‘é‡åŒ–å¹¶å½’æ¡£

**ä½¿ç”¨æ–¹æ³•**:
```bash
python scripts/archive_to_vector.py --dept 216
```

---

## ğŸ“Š å®Œæ•´ç”¨æˆ·æµç¨‹

```
ç”¨æˆ·ç™»å½• â†’ å‰ç«¯è·å– userId + deptId
    â†“
AIå¯¹è¯: POST /ask
    â†“
ä¿å­˜åˆ°æ•°æ®åº“:
  - ai_chat_session (ä¼šè¯)
  - ai_chat_message (æ¶ˆæ¯)
    â†“
ç”¨æˆ·åé¦ˆ: ç‚¹å‡»"æœ‰å¸®åŠ©"
    â†“
ä¿å­˜åé¦ˆ: ai_feedbackè¡¨
    â†“
è®¡ç®—ç½®ä¿¡åº¦ â‰¥ 0.8
    â†“
è‡ªåŠ¨å…¥åº“: ai_knowledge_base (indexed=0)
    â†“
æ··åˆæ£€ç´¢: å‘é‡åº“ + æ•°æ®åº“æœªå½’æ¡£çŸ¥è¯†
    â†“
å®šæ—¶ä»»åŠ¡: archive_to_vector.py
    â†“
å‘é‡åŒ–å½’æ¡£:
  - è½¬æ¢ä¸ºæ–‡æ¡£
  - å¢é‡æ›´æ–°å‘é‡ç´¢å¼•
  - ä¿å­˜åˆ° vector_store/{dept_id}/
  - æ›´æ–° indexed=1
    â†“
ä¸‹æ¬¡æ£€ç´¢: ä»å‘é‡åº“å¿«é€Ÿæ£€ç´¢ âœ…
```

---

## âš ï¸ å·²çŸ¥é—®é¢˜

### 1. å½’æ¡£è„šæœ¬Unicodeç¼–ç é—®é¢˜

**é—®é¢˜**: è„šæœ¬æ‰“å°emojiæ—¶åœ¨Windows GBKç¯å¢ƒä¸‹ä¼šæŠ¥é”™

**å½±å“**: è„šæœ¬å¯èƒ½åœ¨æ›´æ–°æ•°æ®åº“å‰å´©æºƒ

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**: æ‰‹åŠ¨æ›´æ–°æ•°æ®åº“çŠ¶æ€
```python
db.update_knowledge(kb_id, {'indexed': True})
```

**è®¡åˆ’ä¿®å¤**: ç§»é™¤emojiæˆ–è®¾ç½®UTF-8ç¼–ç 

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç”Ÿäº§ç¯å¢ƒé…ç½®

1. **æ•°æ®åº“åˆå§‹åŒ–**
   ```bash
   python scripts/create_tables.py
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡** (`.env`)
   ```env
   DATABASE_TYPE=mysql
   MYSQL_DATABASE=inter_stu_center
   MYSQL_HOST=your_host
   MYSQL_USER=your_user
   MYSQL_PASSWORD=your_password

   SSH_HOST=your_ssh_host
   SSH_USERNAME=your_ssh_user
   SSH_PRIVATE_KEY_PATH=path/to/private_key

   DASHSCOPE_API_KEY=sk-your-key
   ```

3. **å¯¼å…¥åˆå§‹çŸ¥è¯†åº“**
   ```bash
   python scripts/import_knowledge_from_excel.py \
       --file knowledge.xlsx \
       --dept 216 \
       --archive
   ```

4. **å¯åŠ¨æœåŠ¡**
   ```bash
   python app.py
   # æœåŠ¡è¿è¡Œåœ¨ http://0.0.0.0:8087
   ```

5. **é…ç½®å®šæ—¶å½’æ¡£** (å¯é€‰)
   ```bash
   # crontab -e
   0 2 * * * cd /path/to/pomelox_qwen_ai && python scripts/archive_to_vector.py
   ```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æµ‹è¯•ç»“æœ | è¯´æ˜ |
|------|---------|------|
| APIå“åº”æ—¶é—´ | < 2ç§’ | åŒ…å«RAGæ£€ç´¢å’ŒAIç”Ÿæˆ |
| æ•°æ®åº“å†™å…¥ | < 100ms | ä¼šè¯+æ¶ˆæ¯ä¿å­˜ |
| å‘é‡æ£€ç´¢ | < 500ms | åŠ è½½ç´¢å¼•+æ£€ç´¢ |
| å½’æ¡£è„šæœ¬ | ~3ç§’/æ¡ | åŒ…å«å‘é‡åŒ–å’Œç´¢å¼•æ›´æ–° |
| å‘é‡åº“å¤§å° | ~2MB | éƒ¨é—¨216, åŒ…å«æ•°ç™¾æ¡çŸ¥è¯† |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [README.md](../README.md) - é¡¹ç›®æ€»è§ˆ
- [QUICKSTART.md](../QUICKSTART.md) - å¿«é€Ÿå¼€å§‹æŒ‡å—
- [USAGE_GUIDE.md](../USAGE_GUIDE.md) - è¯¦ç»†ä½¿ç”¨æŒ‡å—

---

## âœ… éªŒæ”¶æ¸…å•

### æ•°æ®åº“å±‚
- [x] 4å¼ æ–°è¡¨æˆåŠŸåˆ›å»º
- [x] å¤–é”®çº¦æŸæ­£å¸¸å·¥ä½œ
- [x] ç´¢å¼•å·²æ·»åŠ 
- [x] å¯æˆåŠŸæ’å…¥æµ‹è¯•æ•°æ®

### ä»£ç å±‚
- [x] database/mysql_impl.py æ–°å¢æ–¹æ³•å®ç°
- [x] app.py æ¥å£æ”¯æŒ userId
- [x] åé¦ˆç³»ç»Ÿæ”¯æŒ user_id, dept_id
- [x] æ–°å¢3ä¸ªä¼šè¯ç®¡ç†æ¥å£

### åŠŸèƒ½æµ‹è¯•
- [x] ç”¨æˆ·ç™»å½•åå¯èŠå¤©
- [x] å¯æŸ¥è¯¢è‡ªå·±çš„ä¼šè¯åˆ—è¡¨
- [x] å¯æŸ¥çœ‹ä¼šè¯æ¶ˆæ¯è¯¦æƒ…
- [x] åé¦ˆæäº¤æˆåŠŸ
- [x] ç½®ä¿¡åº¦è®¡ç®—æ­£ç¡®
- [x] å‘é‡åŒ–è„šæœ¬è¿è¡ŒæˆåŠŸ
- [x] æ··åˆæ£€ç´¢(å‘é‡+æ•°æ®åº“)æ­£å¸¸
- [x] å½’æ¡£åå¯ä»å‘é‡åº“æ£€ç´¢

---

**æ›´æ–°æ€»ç»“**: ğŸ‰ **ç³»ç»Ÿå®Œæ•´åŠŸèƒ½å·²å®ç°å¹¶éªŒè¯,å¯æŠ•å…¥ç”Ÿäº§ä½¿ç”¨!**

æ‰€æœ‰æ ¸å¿ƒæµç¨‹éƒ½ç»è¿‡çœŸå®æ•°æ®éªŒè¯,ä»ç”¨æˆ·å¯¹è¯ã€åé¦ˆæ”¶é›†ã€è‡ªåŠ¨å…¥åº“ã€å‘é‡åŒ–å½’æ¡£åˆ°æ£€ç´¢,æ•´ä¸ªé—­ç¯å®Œæ•´è¿ä½œã€‚
